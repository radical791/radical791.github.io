<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgencyOS — 特工状态</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #08090b;
      --bg-card: #0f1114;
      --bg-elevated: #16181c;
      --accent-red: #c41e3a;
      --accent-red-dark: #9e1830;
      --text-primary: #f0eeeb;
      --text-secondary: #a8b0b8;
      --border: #2a2e35;
      --blue-deep: #3b82f6;
      --glow-red: rgba(196, 30, 58, 0.5);
      --glow-red-soft: rgba(196, 30, 58, 0.25);
      --arc-anomaly: #2e4d92;
      --arc-reality: #daa520;
      --arc-competency: #c41e3a;
      --arc-items: #5a4a8a;
      --mvp-color: #c41e3a;
      --reprimand-color: #e67e22;
      --probation-color: #4a5a8a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans SC', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* Neon grid background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        linear-gradient(rgba(196, 30, 58, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(196, 30, 58, 0.08) 1px, transparent 1px);
      background-size: 36px 36px;
      pointer-events: none;
      z-index: 0;
    }

    /* Triangle pattern overlay - alternating up/down triangles */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cpolygon points='0,80 40,0 80,80' fill='rgba(196,30,58,0.05)'/%3E%3Cpolygon points='0,0 40,80 80,0' fill='rgba(196,30,58,0.05)'/%3E%3C/svg%3E");
      background-size: 80px 80px;
      pointer-events: none;
      z-index: 0;
    }

    body>* {
      position: relative;
      z-index: 1;
    }

    /* Top banner */
    .banner {
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 0 25px var(--glow-red-soft), 0 2px 0 rgba(0, 0, 0, 0.3);
      padding: 0.65rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
      gap: 0.75rem;
      position: relative;
      z-index: 100;
    }

    .banner-ecg {
      flex: 0 0 auto;
      width: 260px;
      height: 24px;
      margin: 0 0.25rem;
      position: relative;
      overflow: hidden;
    }

    .banner-ecg::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 24'%3E%3Cpath fill='none' stroke='%23c41e3a' stroke-width='1' d='M0,12 L30,12 L33,11 L36,12 L38,5 L40,19 L42,12 L44,12 L46,13 L52,12 L80,12 L83,11 L86,12 L88,2 L90,22 L92,12 L94,12 L96,13 L102,12 L130,12 L133,11 L136,12 L138,10 L140,14 L142,12 L144,12 L146,13 L152,12 L180,12 L183,11 L186,12 L188,3 L190,21 L192,12 L200,12'/%3E%3C/svg%3E");
      background-repeat: repeat-x;
      background-size: 200px 24px;
      animation: ecg-scroll 2.8s linear infinite, ecg-pulse 4s ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(196, 30, 58, 0.5)) drop-shadow(0 0 8px rgba(196, 30, 58, 0.25));
    }

    @keyframes ecg-scroll {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 200px 0;
      }
    }

    @keyframes ecg-pulse {

      0%,
      100% {
        opacity: 0.65;
        filter: drop-shadow(0 0 4px rgba(196, 30, 58, 0.4)) drop-shadow(0 0 8px rgba(196, 30, 58, 0.2));
      }

      25% {
        opacity: 0.95;
        filter: drop-shadow(0 0 6px rgba(196, 30, 58, 0.6)) drop-shadow(0 0 12px rgba(196, 30, 58, 0.35));
      }

      50% {
        opacity: 0.5;
        filter: drop-shadow(0 0 3px rgba(196, 30, 58, 0.35)) drop-shadow(0 0 6px rgba(196, 30, 58, 0.15));
      }

      75% {
        opacity: 0.85;
        filter: drop-shadow(0 0 5px rgba(196, 30, 58, 0.55)) drop-shadow(0 0 10px rgba(196, 30, 58, 0.3));
      }
    }

    .banner-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .banner-triangle {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 16px solid var(--accent-red);
      filter: drop-shadow(0 0 6px var(--glow-red));
    }

    .banner-title h1 {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      color: var(--text-primary);
      text-shadow: 0 0 10px var(--glow-red-soft), 0 0 20px var(--glow-red-soft);
    }

    .accent-os {
      color: var(--accent-red);
    }

    .banner-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }

    .banner-buttons {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .agent-dropdown-wrap {
      position: relative;
      flex: 1;
      max-width: 280px;
      min-width: 0;
      z-index: 101;
    }

    .agent-dropdown-trigger {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .agent-dropdown-trigger:hover {
      border-color: var(--accent-red);
    }

    .agent-count {
      color: var(--accent-red);
      font-weight: 600;
    }

    .dropdown-arrow {
      margin-left: auto;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .agent-dropdown-panel {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 0.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      max-height: 240px;
      overflow-y: auto;
    }

    .agent-dropdown-panel.open {
      display: block;
    }

    .agent-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .agent-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.25rem 0;
    }

    .agent-checkbox:hover {
      color: var(--accent-red);
    }

    .agent-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-red);
      cursor: pointer;
      flex-shrink: 0;
    }

    .banner-btn-icon {
      width: 1.25rem;
      height: 1.25rem;
      display: block;
    }

    .banner-buttons {
      display: flex;
      align-items: flex-end;
      gap: 0.75rem;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    .banner-btn-with-label {
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
      padding: 0 0 0 0;
      margin: 0;
      width: 4rem;
      min-width: 4rem;
      max-width: 4rem;
      box-sizing: border-box;
      background: transparent;
      border: none;
    }

    .banner-btn-with-label .banner-btn-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 8px;
      border: 1px solid rgba(196, 30, 58, 0.5);
      background: rgba(196, 30, 58, 0.15);
      transition: background 0.2s, border-color 0.2s;
    }

    .banner-btn-with-label:hover .banner-btn-cell {
      background: rgba(196, 30, 58, 0.25);
      border-color: rgba(196, 30, 58, 0.6);
    }

    .banner-btn-cell-with-badge {
      position: relative;
    }

    .banner-email-badge {
      display: none;
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 1rem;
      height: 1rem;
      padding: 0 0.25rem;
      border-radius: 10px;
      background: var(--accent-red);
      color: #fff;
      font-size: 0.65rem;
      font-weight: 700;
      line-height: 1rem;
      text-align: center;
      box-shadow: 0 0 0 1px var(--bg-card);
    }

    .banner-email-badge.visible {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .banner-btn-with-label .banner-btn-icon {
      width: 1.85rem;
      height: 1.85rem;
    }

    .banner-btn-with-label .banner-btn-label {
      font-family: inherit;
      font-size: 0.58rem;
      font-weight: 500;
      line-height: 1.15;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
      color: var(--arc-competency);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      margin: 0;
      padding: 0;
    }

    .items-list-btn {
      padding: 0.5rem 0.65rem;
      background: rgba(196, 30, 58, 0.15);
      border: 1px solid rgba(196, 30, 58, 0.5);
      color: var(--arc-competency);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 8px var(--glow-red-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .items-list-btn.banner-btn-with-label {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
    }

    .items-list-btn.banner-btn-with-label:hover {
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .items-list-btn:hover {
      background: rgba(196, 30, 58, 0.25);
      box-shadow: 0 0 12px var(--glow-red-soft);
    }

    .siphon-btn.banner-btn-with-label {
      padding: 0;
      background: transparent;
      border: none;
    }

    .siphon-btn {
      padding: 0.5rem 0.65rem;
      background: transparent;
      border: 1px solid transparent;
      color: var(--arc-anomaly);
      font-family: inherit;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .siphon-btn .banner-btn-label {
      font-family: inherit;
      color: var(--arc-anomaly);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
    }

    .siphon-btn .banner-btn-cell {
      border-color: rgba(46, 77, 146, 0.5);
      background: rgba(46, 77, 146, 0.15);
    }

    .siphon-btn:hover .banner-btn-cell {
      background: rgba(46, 77, 146, 0.3);
      border-color: rgba(46, 77, 146, 0.6);
    }

    .siphon-eye-icon {
      width: 1.25rem;
      height: 1.25rem;
      transform-origin: center;
      transform-box: fill-box;
      animation: siphon-eye 6s ease-in-out infinite;
    }
    @keyframes siphon-eye {
      0%, 1.5%, 3%, 98.5%, 100% { transform: scale(1) scaleY(1) rotate(0deg); }
      2%, 99% { transform: scale(1) scaleY(0.1) rotate(0deg); }
      20% { transform: scale(1.04) scaleY(1) rotate(-0.6deg); }
      40% { transform: scale(1) scaleY(1) rotate(0deg); }
      60% { transform: scale(1.04) scaleY(1) rotate(0.6deg); }
      80% { transform: scale(1) scaleY(1) rotate(0deg); }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 1rem;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 0 30px var(--glow-red-soft);
      max-width: 560px;
      width: 100%;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 1.1rem;
      color: var(--arc-items);
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      padding: 0.25rem;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1rem 1.25rem;
      overflow-y: auto;
      flex: 1;
    }

    .items-list-loading {
      color: var(--text-secondary);
      text-align: center;
      padding: 2rem;
    }

    .items-list-modal .items-list-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .items-list-modal .items-list-item summary {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--arc-items);
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .items-list-modal .items-list-item summary::-webkit-details-marker {
      display: none;
    }

    .items-list-modal .items-list-item summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 5px solid currentColor;
      margin-right: 0.5rem;
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    .items-list-modal .items-list-item[open] summary::before {
      transform: rotate(90deg);
    }

    .items-list-modal .items-list-item .item-price {
      flex-shrink: 0;
      color: var(--arc-reality);
      font-weight: 600;
    }

    .items-list-modal .items-list-item .item-desc {
      padding: 0 0.75rem 0.75rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .mission-archive-modal {
      max-width: 640px;
    }

    .joint-assessment-modal {
      max-width: 680px;
    }

    .agency-dice-modal {
      max-width: 420px;
    }

    .agency-dice-modal .modal-title {
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .siphon-modal .modal-title.siphon-modal-title {
      color: var(--arc-anomaly);
      text-shadow: 0 0 8px rgba(46, 77, 146, 0.5);
    }

    .siphon-modal {
      position: relative;
      overflow: visible;
    }

    .siphon-floating-pic {
      display: none;
      position: absolute;
      right: -100px;
      bottom: 0;
      left: auto;
      top: auto;
      width: 140px;
      height: 70%;
      max-height: 280px;
      z-index: 0;
      pointer-events: none;
      align-items: flex-end;
      justify-content: flex-end;
    }

    .siphon-floating-pic.visible {
      display: flex;
    }

    .siphon-floating-pic img {
      width: auto;
      height: 100%;
      max-width: 180px;
      object-fit: contain;
      object-position: right bottom;
    }

    .siphon-modal .siphon-modal-header,
    .siphon-modal .modal-body {
      position: relative;
      z-index: 1;
    }

    .siphon-modal .siphon-floating-pic.visible ~ .siphon-modal-header,
    .siphon-modal .siphon-floating-pic.visible ~ .modal-body {
      padding-right: 48px;
    }

    @media (max-width: 768px) {
      .siphon-floating-pic.visible {
        display: none !important;
      }
      .siphon-modal .siphon-floating-pic.visible ~ .siphon-modal-header,
      .siphon-modal .siphon-floating-pic.visible ~ .modal-body {
        padding-right: 0;
      }
      .siphon-modal .siphon-modal-header,
      .siphon-modal .modal-body {
        padding-right: 1.5rem;
      }
      .siphon-modal .siphon-floating-pic.visible ~ .siphon-modal-header,
      .siphon-modal .siphon-floating-pic.visible ~ .modal-body {
        padding-right: 1.5rem;
      }
      .siphon-store-content .items-list-item summary {
        padding-left: 0.75rem;
        padding-right: 1rem;
      }
    }

    .siphon-modal .siphon-store-title-altered {
      display: inline-block;
      position: relative;
      color: var(--arc-anomaly);
      text-shadow:
        0 0 8px rgba(46, 77, 146, 0.6),
        -1px 0 rgba(0, 255, 255, 0.25),
        1px 0 rgba(255, 0, 255, 0.25),
        0 -1px rgba(0, 255, 255, 0.15),
        0 1px rgba(255, 0, 255, 0.15);
      letter-spacing: 0.02em;
    }

    .siphon-modal .siphon-store-title-altered .siphon-store-char {
      display: inline-block;
      animation: siphon-char-jump 1.4s ease-in-out infinite;
    }

    @keyframes siphon-char-jump {
      0%, 100% { transform: translateY(0); }
      25% { transform: translateY(-5px); }
      50% { transform: translateY(0); }
      75% { transform: translateY(3px); }
    }

    .siphon-u-message {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 1rem;
      padding: 0.6rem 0.75rem;
      background: rgba(46, 77, 146, 0.12);
      border: 1px solid rgba(46, 77, 146, 0.35);
      border-radius: 4px;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .siphon-u-message .siphon-item-eye {
      width: 1.25rem;
      height: 1.25rem;
      flex-shrink: 0;
      color: var(--arc-anomaly);
    }

    .siphon-u-message .siphon-u-text {
      flex: 1;
      min-width: 0;
    }

    .siphon-u-message .siphon-u-quote {
      color: var(--arc-anomaly);
      font-style: italic;
    }

    .siphon-help {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    .siphon-input {
      width: 100%;
      max-width: 200px;
      padding: 0.5rem 0.6rem;
      font-size: 0.9rem;
      border: 1px solid rgba(46, 77, 146, 0.5);
      border-radius: 4px;
      background: var(--bg-dark);
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }

    .siphon-submit-btn {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      background: rgba(46, 77, 146, 0.3);
      color: var(--arc-anomaly);
      border: 1px solid var(--arc-anomaly);
      border-radius: 4px;
      cursor: pointer;
    }

    .siphon-submit-btn:hover {
      background: rgba(46, 77, 146, 0.45);
    }

    .siphon-error-msg {
      color: var(--accent-red);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .siphon-error-msg .siphon-error-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.25em;
      height: 1.25em;
      margin-right: 0.25rem;
      background: var(--accent-red);
      color: var(--bg-card);
      border-radius: 50%;
      font-size: 0.85em;
      font-weight: 700;
    }

    .siphon-store-content .items-list-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .siphon-store-content .items-list-item summary {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--arc-anomaly);
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .siphon-store-content .items-list-item summary::-webkit-details-marker {
      display: none;
    }

    .siphon-store-content .items-list-item summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 5px solid currentColor;
      margin-right: 0.5rem;
    }

    .siphon-store-content .items-list-item[open] summary::before {
      transform: rotate(90deg);
    }

    /* Email notification (reminder) modal — Triangle Agency theme (职能) */
    .email-reminder-modal {
      max-width: 380px;
      border: 1px solid rgba(196, 30, 58, 0.4);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px var(--glow-red-soft);
    }
    .email-reminder-modal .email-reminder-header {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: linear-gradient(135deg, rgba(196, 30, 58, 0.22) 0%, rgba(196, 30, 58, 0.06) 100%);
      border-bottom: 1px solid rgba(196, 30, 58, 0.35);
      border-radius: 8px 8px 0 0;
    }
    .email-reminder-modal .email-reminder-icon {
      flex-shrink: 0;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(196, 30, 58, 0.35);
      border-radius: 10px;
      color: #e85c75;
    }
    .email-reminder-modal .email-reminder-icon svg {
      width: 1.4rem;
      height: 1.4rem;
    }
    .email-reminder-modal .email-reminder-header-text {
      flex: 1;
      min-width: 0;
    }
    .email-reminder-modal .email-reminder-title {
      margin: 0 0 0.2rem 0;
      font-size: 1.05rem;
      font-weight: 600;
      color: #f0aab5;
      text-shadow: 0 0 8px var(--glow-red-soft);
    }
    .email-reminder-modal .email-reminder-subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.75);
    }
    .email-reminder-modal .email-reminder-header .modal-close {
      color: rgba(255, 255, 255, 0.7);
    }
    .email-reminder-modal .email-reminder-body {
      padding: 1.25rem 1.25rem 1.5rem;
    }
    .email-reminder-modal .email-reminder-no-mail {
      margin: 0;
      color: var(--text-secondary);
      text-align: center;
      font-size: 0.95rem;
    }
    .email-reminder-modal .email-reminder-open-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.65rem 1.25rem;
      background: linear-gradient(180deg, var(--accent-red) 0%, var(--accent-red-dark) 100%);
      color: #fff;
      border: 1px solid rgba(196, 30, 58, 0.5);
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 2px 10px var(--glow-red-soft);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .email-reminder-modal .email-reminder-open-btn:hover {
      background: linear-gradient(180deg, #d42a48 0%, var(--accent-red) 100%);
      box-shadow: 0 4px 14px var(--glow-red-soft);
    }
    .email-reminder-modal .email-reminder-open-icon {
      display: inline-flex;
      width: 1.1rem;
      height: 1.1rem;
    }
    .email-reminder-modal .email-reminder-open-icon svg {
      width: 100%;
      height: 100%;
    }

    /* Email content (read) modal — Triangle Agency theme */
    .email-content-modal {
      max-width: 520px;
      border: 1px solid rgba(196, 30, 58, 0.35);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45), 0 0 25px var(--glow-red-soft);
    }
    .email-content-modal .email-content-header {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: linear-gradient(135deg, rgba(30, 15, 18, 0.98) 0%, rgba(20, 10, 12, 0.99) 100%);
      border-bottom: 1px solid rgba(196, 30, 58, 0.4);
      border-radius: 8px 8px 0 0;
    }
    .email-content-modal .email-content-icon {
      flex-shrink: 0;
      width: 2.25rem;
      height: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(196, 30, 58, 0.3);
      border-radius: 8px;
      color: #e85c75;
    }
    .email-content-modal .email-content-icon svg {
      width: 1.25rem;
      height: 1.25rem;
    }
    .email-content-modal .email-content-header-inner {
      flex: 1;
      min-width: 0;
    }
    .email-content-modal .email-content-title {
      margin: 0 0 0.35rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #f0aab5;
      text-shadow: 0 0 6px var(--glow-red-soft);
    }
    .email-content-modal .email-content-meta {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.55);
    }
    .email-content-modal .email-content-from {
      font-style: normal;
    }
    .email-content-modal .email-content-header .modal-close {
      color: rgba(255, 255, 255, 0.6);
    }
    .email-content-modal .email-content-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(196, 30, 58, 0.4), transparent);
    }
    .email-content-modal .email-content-body-wrap {
      padding: 1.25rem 1.5rem 1.5rem;
      background: rgba(12, 10, 11, 0.7);
      border-radius: 0 0 8px 8px;
      max-height: 55vh;
      overflow-y: auto;
    }
    .email-content-modal .email-content-body {
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.95rem;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.9);
    }

    .siphon-store-content .items-list-item .item-title {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .siphon-store-content .siphon-item-eye {
      width: 1rem;
      height: 1rem;
      flex-shrink: 0;
      stroke: currentColor;
      opacity: 0.85;
    }
    .siphon-store-content .items-list-item .item-price {
      flex-shrink: 0;
      color: var(--arc-anomaly);
      font-weight: 600;
    }

    .siphon-store-content .items-list-item .item-desc {
      padding: 0 0.75rem 0.75rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .agency-dice-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 1rem;
    }

    .agency-dice-body {
      cursor: pointer;
      user-select: none;
    }

    .dice-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      justify-items: center;
      gap: 1rem;
      padding: 0.5rem 0;
      max-width: 220px;
      margin: 0 auto;
    }

    .d4-die {
      position: relative;
      width: 56px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .d4-die .d4-triangle {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 48px;
      height: 42px;
      margin-left: -24px;
      margin-top: -21px;
      background: linear-gradient(to bottom, #b23b3b 0%, #b23b3b 65%, #cccccc 65%, #cccccc 100%);
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      transform-origin: 50% 50%;
      transition: none;
      filter: drop-shadow(0 0 6px var(--glow-red));
    }

    .d4-die[data-value="1"] .d4-triangle,
    .d4-die[data-value="4"] .d4-triangle { transform: rotate(120deg); }
    .d4-die[data-value="2"] .d4-triangle { transform: rotate(240deg); }
    .d4-die[data-value="3"] .d4-triangle { transform: rotate(0deg); }

    .d4-die .d4-value {
      position: absolute;
      top: 22%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
      font-size: 1rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      color: #fff;
      text-shadow: 0 0 4px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8);
    }

    .agency-dice-body.rolling .d4-die[data-value="1"] .d4-triangle,
    .agency-dice-body.rolling .d4-die[data-value="4"] .d4-triangle {
      animation: d4-roll-to-120 0.55s ease-out forwards;
    }
    .agency-dice-body.rolling .d4-die[data-value="2"] .d4-triangle {
      animation: d4-roll-to-240 0.55s ease-out forwards;
    }
    .agency-dice-body.rolling .d4-die[data-value="3"] .d4-triangle {
      animation: d4-roll-to-0 0.55s ease-out forwards;
    }

    .agency-dice-body.rolling .d4-die:nth-child(1) .d4-triangle { animation-delay: 0s; }
    .agency-dice-body.rolling .d4-die:nth-child(2) .d4-triangle { animation-delay: 0.03s; }
    .agency-dice-body.rolling .d4-die:nth-child(3) .d4-triangle { animation-delay: 0.06s; }
    .agency-dice-body.rolling .d4-die:nth-child(4) .d4-triangle { animation-delay: 0.09s; }
    .agency-dice-body.rolling .d4-die:nth-child(5) .d4-triangle { animation-delay: 0.12s; }
    .agency-dice-body.rolling .d4-die:nth-child(6) .d4-triangle { animation-delay: 0.15s; }

    @keyframes d4-roll-to-0 {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(720deg); }
    }
    @keyframes d4-roll-to-120 {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(840deg); }
    }
    @keyframes d4-roll-to-240 {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(960deg); }
    }

    .agency-dice-body.rolling .d4-die {
      animation: dice-pulse 0.12s ease-in-out 4;
    }

    @keyframes dice-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.08); }
    }

    .agency-dice-success {
      text-align: center;
      margin-top: 1rem;
      font-weight: 600;
      color: var(--accent-red);
      font-size: 1rem;
    }

    .joint-assessment-modal .modal-title.joint-assessment-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.02em;
    }

    .ta-report {
      font-size: 0.85rem;
      line-height: 1.7;
      color: var(--text-primary);
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1.5rem;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.3), 0 0 15px var(--glow-red-soft);
    }

    .ta-report-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(196, 30, 58, 0.3);
    }

    .ta-report-logo {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
      margin-bottom: 0.25rem;
    }

    .ta-report-doc-type {
      font-size: 0.8rem;
      color: var(--text-secondary);
      letter-spacing: 0.08em;
      margin-bottom: 0.5rem;
    }

    .ta-report-meta {
      font-size: 0.7rem;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
    }

    .ta-report-meta span {
      margin-right: 1rem;
    }

    .ta-report-section {
      margin-bottom: 1.25rem;
    }

    .ta-report-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent-red);
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }

    .ta-report-body {
      color: var(--text-secondary);
      font-size: 0.82rem;
    }

    .ta-report-body p {
      margin: 0.4rem 0;
    }

    .ta-report-body .bullet {
      margin-left: 1rem;
      padding-left: 0.5rem;
      border-left: 2px solid rgba(196, 30, 58, 0.3);
    }

    .ta-report-body .redacted {
      color: var(--accent-red);
      letter-spacing: 0.2em;
    }

    .ta-report-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(196, 30, 58, 0.3), transparent);
      margin: 1rem 0;
    }

    .ta-report-note {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 0.5rem;
    }

    .mission-archive-modal .modal-title.mission-archive-title {
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .mission-report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 1rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid rgba(196, 30, 58, 0.4);
      box-shadow: 0 1px 0 var(--glow-red-soft);
    }

    .mission-report-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .mission-report-brand .mission-report-triangle {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 12px solid var(--accent-red);
      filter: drop-shadow(0 0 4px var(--glow-red));
    }

    .mission-report-brand-text {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .mission-report-brand-sub {
      font-size: 0.75rem;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
      margin-top: 0.15rem;
    }

    .mission-archive-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .mission-archive-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .mission-archive-item:hover {
      border-color: var(--accent-red);
      background: rgba(196, 30, 58, 0.08);
    }

    .mission-archive-date {
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-width: 6rem;
    }

    .mission-archive-codename {
      font-weight: 600;
      color: var(--arc-competency);
    }

    .mission-back-btn {
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .mission-back-btn:hover {
      color: var(--accent-red);
      border-color: var(--accent-red);
    }

    .mission-report {
      font-size: 0.9rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.2), 0 0 20px var(--glow-red-soft);
    }

    .mission-report-section {
      margin-bottom: 1.5rem;
      padding: 1rem 1.25rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      border-left: 3px solid var(--accent-red);
    }

    .mission-report-section:last-of-type {
      margin-bottom: 0;
    }

    .mission-report-header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem 2rem;
      padding: 1rem 1.25rem;
      background: rgba(196, 30, 58, 0.08);
      border-radius: 6px;
      border: 1px solid rgba(196, 30, 58, 0.3);
      margin-bottom: 1.5rem;
      border-left: none;
    }

    .mission-report-header-item {
      display: flex;
      gap: 0.5rem;
    }

    .mission-report-header-item .mission-report-field {
      min-width: 4.5rem;
    }

    .mission-report-label {
      font-weight: 600;
      color: var(--accent-red);
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mission-report-value {
      color: var(--text-primary);
      line-height: 1.6;
    }

    .mission-report-multiline {
      white-space: pre-line;
    }

    .mission-report-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.5rem 2rem;
    }

    .mission-report-row {
      display: contents;
    }

    .mission-report-row span:first-child {
      color: var(--text-secondary);
    }

    .mission-report-field {
      font-weight: 500;
      color: var(--arc-reality) !important;
    }

    .mission-report-analysis .mission-report-grid {
      padding-top: 0.5rem;
    }

    .mission-report-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 2rem;
    }

    .mission-report-meta-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .mission-report-meta-row .mission-report-field {
      min-width: 5rem;
    }

    .mission-report-meta-row.score.察看期 {
      color: #7a8fd4;
      text-shadow: 0 0 8px rgba(122, 143, 212, 0.5);
    }

    .mission-report-meta-row.score.察看期 .score-icon,
    .mission-report-meta-row.score.察看期 .mission-report-field {
      color: #7a8fd4 !important;
    }

    .mission-report-meta-row.score.察看期 .score-icon {
      font-size: 0.9rem;
    }

    .mission-report-meta-row.score.mvp {
      color: var(--mvp-color);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .mission-report-meta-row.score.mvp .score-icon,
    .mission-report-meta-row.score.mvp .mission-report-field {
      color: var(--mvp-color) !important;
    }

    .mission-report-meta-row.score.mvp .score-icon {
      font-size: 0.9rem;
    }

    /* Main layout: left sidebar + content */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left section */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      box-shadow: 2px 0 15px var(--glow-red-soft);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-section {
      background: var(--bg-elevated);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 0 20px var(--glow-red-soft), inset 0 0 30px rgba(0, 0, 0, 0.2);
    }

    .gm-profile-section {
      position: relative;
    }

    .glitch-sos-btn {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.65rem;
      font-family: monospace;
      color: rgba(196, 30, 58, 0.9);
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(196, 30, 58, 0.5);
      border-radius: 2px;
      cursor: pointer;
      letter-spacing: 0.08em;
      overflow: visible;
      animation: glitch-btn 3.5s steps(1) infinite;
    }

    .glitch-sos-btn:hover {
      color: var(--accent-red);
      border-color: var(--accent-red);
      background: rgba(196, 30, 58, 0.15);
      animation: none;
      box-shadow: 0 0 12px var(--glow-red-soft);
    }

    .glitch-text {
      position: relative;
      display: inline-block;
    }

    .glitch-text::before,
    .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
    }

    .glitch-sos-btn .glitch-text {
      animation: glitch-text 3.5s steps(1) infinite;
    }

    .glitch-sos-btn .glitch-text::before {
      content: attr(data-text);
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      color: #0ff;
      opacity: 0;
      clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
      animation: glitch-layer 3.5s steps(1) infinite;
    }

    .glitch-sos-btn .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      color: #f0f;
      opacity: 0;
      clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
      animation: glitch-layer 3.5s steps(1) infinite 0.05s;
    }

    @keyframes glitch-btn {

      0%,
      25%,
      50%,
      75%,
      97%,
      100% {
        opacity: 1;
        transform: translate(0);
      }

      26% {
        opacity: 0.7;
        transform: translate(-2px, 2px);
      }

      27% {
        opacity: 1;
        transform: translate(2px, -2px);
      }

      28% {
        opacity: 1;
        transform: translate(0);
      }

      51% {
        opacity: 0.8;
        transform: translate(2px, -1px);
      }

      52% {
        opacity: 1;
        transform: translate(-1px, 1px);
      }

      53% {
        opacity: 1;
        transform: translate(0);
      }

      76% {
        opacity: 0.9;
        transform: translate(-1px, -1px);
      }

      77% {
        opacity: 1;
        transform: translate(1px, 1px);
      }

      78% {
        opacity: 1;
        transform: translate(0);
      }
    }

    @keyframes glitch-text {

      0%,
      25%,
      50%,
      75%,
      97%,
      100% {
        transform: translate(0);
        text-shadow: none;
      }

      26% {
        transform: translate(2px, -2px);
        text-shadow: -2px 0 #0ff, 2px 0 #f0f;
      }

      27% {
        transform: translate(-2px, 2px);
        text-shadow: 2px 0 #0ff, -2px 0 #f0f;
      }

      28% {
        transform: translate(0);
        text-shadow: none;
      }

      51% {
        transform: translate(-1px, 1px);
        text-shadow: 1px 0 #0ff, -1px 0 #f0f;
      }

      52% {
        transform: translate(0);
        text-shadow: none;
      }

      76% {
        transform: translate(1px, -1px);
        text-shadow: -1px 0 #f0f, 1px 0 #0ff;
      }

      77% {
        transform: translate(0);
        text-shadow: none;
      }
    }

    @keyframes glitch-layer {

      0%,
      25%,
      50%,
      75%,
      97%,
      100% {
        opacity: 0;
        transform: translate(0);
      }

      26% {
        opacity: 0.9;
        transform: translate(-2px, 0);
      }

      27% {
        opacity: 0.9;
        transform: translate(2px, 0);
      }

      28% {
        opacity: 0;
        transform: translate(0);
      }

      51% {
        opacity: 0.7;
        transform: translate(2px, 0);
      }

      52% {
        opacity: 0;
        transform: translate(0);
      }

      76% {
        opacity: 0.8;
        transform: translate(-2px, 0);
      }

      77% {
        opacity: 0;
        transform: translate(0);
      }
    }

    .sidebar-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-red);
      text-shadow: 0 0 10px var(--glow-red-soft), 0 0 20px rgba(196, 30, 58, 0.15);
      margin-bottom: 0.75rem;
    }

    .agency-stats {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .agency-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .agency-stat .label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .agency-stat .value {
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--accent-red);
      text-shadow: 0 0 12px var(--glow-red-soft), 0 0 4px var(--glow-red);
    }

    .agency-stat .value-text {
      font-weight: 500;
      font-size: 0.95rem;
      color: var(--text-primary);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .gm-profile {
      text-align: center;
      padding: 0.5rem 0;
    }

    .gm-profile-frame {
      display: inline-block;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 15px var(--glow-red-soft);
    }

    .gm-profile-frame img {
      display: block;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: inset 0 0 0 3px #000;
    }

    .gm-profile-frame .gm-profile-placeholder {
      display: flex;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      margin: 0;
      border: none;
      box-shadow: inset 0 0 0 3px #000;
    }

    .gm-info {
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    .gm-info-row {
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }

    .gm-info-row .label {
      color: var(--text-secondary);
      margin-right: 0.25rem;
    }

    .agency-news {
      flex: 1;
      min-height: 120px;
      max-height: 280px;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .agency-news-content {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }

    .agency-news-content::-webkit-scrollbar {
      width: 6px;
    }

    .agency-news-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .news-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .news-item:last-child {
      border-bottom: none;
    }

    .news-item-date {
      font-size: 0.8rem;
      color: var(--accent-red);
      margin-bottom: 0.2rem;
    }

    .agency-news-placeholder {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Main section */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #content:has(.welcome-state) {
      flex: 1;
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    .main-content::-webkit-scrollbar {
      width: 8px;
    }

    .main-content::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    .main-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .main-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent-red-dark);
      box-shadow: 0 0 6px var(--glow-red-soft);
    }

    .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.25rem;
    }

    .agent-card {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 25px var(--glow-red-soft), inset 0 0 40px rgba(0, 0, 0, 0.15);
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .agent-card:hover {
      border-color: var(--accent-red-dark);
      box-shadow: 0 0 25px var(--glow-red-soft), 0 0 40px var(--glow-red-soft);
    }

    .agent-card-flip {
      perspective: 1000px;
      width: 100%;
      height: 100%;
    }

    .agent-card-inner {
      position: relative;
      width: 100%;
      min-height: 320px;
      transition: transform 0.5s ease;
      transform-style: preserve-3d;
    }

    .agent-card-flip.flipped .agent-card-inner {
      transform: rotateY(180deg);
    }

    .agent-card-flip.flipped .agent-card-front .agent-track-btn {
      visibility: hidden;
      pointer-events: none;
    }

    .agent-card-front,
    .agent-card-back {
      backface-visibility: hidden;
    }

    .agent-card-back {
      position: absolute;
      inset: 0;
      transform: rotateY(180deg);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 0 25px var(--glow-red-soft);
      padding: 1rem 1.25rem;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .agent-card-back .agent-track-btn-back {
      position: static;
      top: auto;
      left: auto;
      width: auto;
      margin-bottom: 1rem;
      padding: 0.35rem 0.6rem;
      border-bottom: none;
      display: inline-block;
    }
    .agent-card-back .agent-track-btn-back::after {
      content: ' ↺';
      opacity: 0.9;
    }

    .agent-card-back-tracks {
      margin-top: 0;
      min-width: 0;
    }

    .agent-card-back-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent-red);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .arc-tracks-help {
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 1rem;
      padding: 0.5rem 0;
    }
    .arc-track-help {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.45;
      margin-bottom: 0.5rem;
    }

    .arc-track {
      margin-bottom: 1rem;
      min-width: 0;
    }

    .arc-track:last-child {
      margin-bottom: 0;
    }

    .arc-track-name {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.35rem;
    }

    .arc-track.职能 .arc-track-name { color: var(--arc-competency); }
    .arc-track.现实 .arc-track-name { color: var(--arc-reality); }
    .arc-track.异常 .arc-track-name { color: var(--arc-anomaly); }

    /* Horizontal track: 30 boxes, wrap to next line when needed; responsive box size */
    .arc-track-bar {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: center;
      gap: 0;
      row-gap: 0.75rem;
      margin-bottom: 0.5rem;
      max-width: 100%;
      min-width: 0;
    }

    .arc-track-cell {
      display: flex;
      flex-direction: row;
      align-items: center;
      flex-shrink: 0;
    }

    .arc-track-connector {
      flex-shrink: 0;
      background: currentColor;
      opacity: 0.6;
    }

    .arc-track-connector.h {
      width: clamp(3px, 0.8vw, 6px);
      height: 2px;
      min-width: 3px;
    }

    .arc-track.职能 .arc-track-connector.h { color: var(--arc-competency); }
    .arc-track.现实 .arc-track-connector.h { color: var(--arc-reality); }
    .arc-track.异常 .arc-track-connector.h { color: var(--arc-anomaly); }

    .arc-track-bar .tracker-step {
      width: clamp(22px, 5vw, 40px);
      height: clamp(22px, 5vw, 40px);
      min-width: 22px;
      min-height: 22px;
      border: 2px solid var(--border);
      border-radius: 4px;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(0.6rem, 1.8vw, 0.8rem);
      font-weight: 700;
      color: var(--text-secondary);
      flex-shrink: 0;
      position: relative;
    }

    .arc-track.职能 .arc-track-bar .tracker-step { border-color: rgba(196, 30, 58, 0.5); }
    .arc-track.现实 .arc-track-bar .tracker-step { border-color: rgba(218, 165, 32, 0.5); }
    .arc-track.异常 .arc-track-bar .tracker-step { border-color: rgba(46, 77, 146, 0.5); }

    .arc-track.职能 .arc-track-bar .tracker-step.filled { border-color: var(--arc-competency); background: rgba(196, 30, 58, 0.35); color: var(--arc-competency); }
    .arc-track.现实 .arc-track-bar .tracker-step.filled { border-color: var(--arc-reality); background: rgba(218, 165, 32, 0.35); color: var(--arc-reality); }
    .arc-track.异常 .arc-track-bar .tracker-step.filled { border-color: var(--arc-anomaly); background: rgba(46, 77, 146, 0.35); color: var(--arc-anomaly); }

    .arc-track.职能 .arc-track-bar .tracker-step.struck { border-color: var(--arc-competency); background: var(--bg-dark); color: var(--text-secondary); }
    .arc-track.现实 .arc-track-bar .tracker-step.struck { border-color: var(--arc-reality); background: var(--bg-dark); color: var(--text-secondary); }
    .arc-track.异常 .arc-track-bar .tracker-step.struck { border-color: var(--arc-anomaly); background: var(--bg-dark); color: var(--text-secondary); }

    .arc-track-bar .tracker-step.struck::after {
      content: '✕';
      position: absolute;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .arc-track-bar .tracker-step.struck .tracker-step-inner {
      display: none;
    }

    .arc-track-bar .tracker-step .tracker-step-inner {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .agent-track-btn {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      z-index: 2;
      padding: 0.35rem 0.6rem;
      font-size: 0.75rem;
      font-family: inherit;
      font-weight: 600;
      color: var(--accent-red);
      background: rgba(196, 30, 58, 0.15);
      border: 1px solid rgba(196, 30, 58, 0.5);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 6px var(--glow-red-soft);
    }

    .agent-track-btn:hover {
      border-color: var(--accent-red);
      box-shadow: 0 0 10px var(--glow-red-soft);
    }

    .agent-track-btn::after {
      content: ' ↺';
      opacity: 0.9;
    }

    .agent-badges {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.35rem;
      z-index: 1;
      background: transparent;
    }

    .agent-badge-img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      background: transparent;
    }

    .agent-card-header {
      background: var(--bg-elevated);
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 10px var(--glow-red-soft);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .agent-header-top {
      display: flex;
      gap: 1.25rem;
      align-items: center;
    }

    .agent-profile-slot {
      flex-shrink: 0;
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
    }

    .agent-profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-dark);
      object-fit: cover;
      box-shadow: inset 0 0 0 2px #000, 0 0 12px var(--glow-red-soft);
      display: block;
    }

    .agent-profile-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-align: center;
      padding: 0.5rem;
      box-sizing: border-box;
      box-shadow: inset 0 0 0 2px #000;
    }

    .agent-name-row {
      flex: 1;
      min-width: 0;
    }

    .agent-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .agent-aka {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-aka::before {
      content: 'AKA ';
      font-weight: 600;
      color: var(--accent-red);
    }

    .agent-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-title .label {
      font-weight: 600;
      color: var(--accent-red);
      margin-right: 0.25rem;
    }

    .agent-agency-rating {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
      min-height: 2.6em;
      line-height: 1.35;
    }

    .agent-agency-rating .label {
      font-weight: 600;
      color: var(--accent-red);
      margin-right: 0.25rem;
    }

    .agent-agency-rating .rating-value.tier-0 {
      color: #34d399;
    }

    .agent-agency-rating .rating-value.tier-1-3 {
      color: var(--arc-reality);
    }

    .agent-agency-rating .rating-value.tier-4-6 {
      color: var(--reprimand-color);
    }

    .agent-agency-rating .rating-value.tier-7-9 {
      color: var(--arc-anomaly);
    }

    .agent-agency-rating .rating-value.tier-10 {
      color: var(--accent-red);
      font-weight: 700;
    }

    .arc-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      min-width: 0;
    }

    .arc-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .arc-badge.异常 {
      background: rgba(46, 77, 146, 0.2);
      color: var(--arc-anomaly);
      border: 1px solid rgba(46, 77, 146, 0.5);
      box-shadow: 0 0 8px rgba(46, 77, 146, 0.2);
    }

    .arc-badge.现实 {
      background: rgba(218, 165, 32, 0.15);
      color: var(--arc-reality);
      border: 1px solid rgba(218, 165, 32, 0.5);
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.2);
    }

    .arc-badge.职能 {
      background: rgba(196, 30, 58, 0.15);
      color: var(--arc-competency);
      border: 1px solid rgba(196, 30, 58, 0.5);
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .arc-badge-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 2px;
    }

    .arc-badge.异常 .arc-badge-icon {
      background: var(--arc-anomaly);
      color: white;
    }

    .arc-badge.现实 .arc-badge-icon {
      background: var(--arc-reality);
      color: white;
    }

    .arc-badge.职能 .arc-badge-icon {
      background: var(--arc-competency);
      color: white;
    }

    .agent-scores {
      display: grid;
      grid-template-columns: auto auto;
      grid-template-rows: auto auto;
      grid-auto-flow: column;
      gap: 0.25rem 1rem;
      margin-top: 0.5rem;
      align-items: center;
    }

    .score {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .score strong {
      min-width: 1.5em;
      text-align: left;
      font-variant-numeric: tabular-nums;
    }

    .score-icon {
      font-size: 0.9rem;
      line-height: 1;
    }

    .score.嘉奖 {
      color: #34d399;
      text-shadow: 0 0 6px rgba(52, 211, 153, 0.3);
    }

    .score.嘉奖 .score-icon {
      color: #34d399;
    }

    .score.申诫 {
      color: var(--reprimand-color);
      text-shadow: 0 0 6px rgba(230, 126, 34, 0.3);
    }

    .score.申诫 .score-icon {
      color: var(--reprimand-color);
    }

    .score.察看期 {
      color: var(--probation-color);
      text-shadow: 0 0 6px rgba(74, 90, 138, 0.3);
    }

    .score.察看期 .score-icon {
      color: var(--probation-color);
    }

    .score.mvp {
      color: var(--mvp-color);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .score.mvp .score-icon {
      color: var(--mvp-color);
    }

    .agent-body {
      padding: 1.25rem;
    }

    .section {
      margin-bottom: 1rem;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-red);
      text-shadow: 0 0 6px var(--glow-red-soft);
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid var(--border);
    }

    .qa-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .qa-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 0.25rem 0;
    }

    .qa-item .value {
      font-weight: 600;
      color: var(--blue-deep);
      text-shadow: 0 0 6px rgba(59, 130, 246, 0.3);
    }

    .ability-list {
      list-style: none;
    }

    .ability-item {
      margin-bottom: 0.75rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .ability-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .ability-name {
      font-weight: 600;
      color: var(--accent-red);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      text-shadow: 0 0 4px var(--glow-red-soft);
    }

    .ability-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: pre-line;
      line-height: 1.5;
    }

    .reference-section {
      margin-bottom: 1rem;
    }

    .ref-block {
      margin-bottom: 0.5rem;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .ref-block.异常 {
      border-color: rgba(46, 77, 146, 0.5);
      box-shadow: 0 0 8px rgba(46, 77, 146, 0.2);
    }

    .ref-block.异常 .ref-block-title {
      background: rgba(46, 77, 146, 0.2);
      color: var(--arc-anomaly);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px rgba(46, 77, 146, 0.4);
    }

    .ref-block.异常 .ref-item summary {
      color: var(--arc-anomaly);
      display: flex;
      align-items: center;
    }

    .ref-block.异常 .ref-item summary .ability-summary-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      min-width: 0;
    }

    .ref-block.异常 .ref-item summary .ability-name {
      color: inherit;
      text-shadow: none;
    }

    .ref-block.异常 .ability-proficient {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--arc-anomaly);
      flex-shrink: 0;
    }

    .ref-block.现实 {
      border-color: rgba(218, 165, 32, 0.5);
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.2);
    }

    .ref-block.现实 .ref-block-title {
      background: rgba(218, 165, 32, 0.15);
      color: var(--arc-reality);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px rgba(218, 165, 32, 0.4);
    }

    .ref-block.现实 .ref-item summary {
      color: var(--arc-reality);
    }

    .reality-split-tracker {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0.5rem 0 0;
    }

    .ref-block.现实 .ref-item-desc .reality-split-tracker {
      padding: 0.5rem 0 0;
    }

    .reality-split-tracker .tracker-start {
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 12px solid var(--arc-reality);
      margin-right: 4px;
    }

    .reality-split-tracker .tracker-connector {
      flex: 0 0 8px;
      height: 2px;
      background: var(--arc-reality);
    }

    .reality-split-tracker .tracker-step {
      width: 24px;
      height: 24px;
      border: 2px solid var(--arc-reality);
      border-radius: 2px;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .reality-split-tracker .tracker-step.filled {
      background: var(--arc-reality);
      color: var(--bg-dark);
    }

    .reality-split-tracker .tracker-step.filled.warning {
      background: var(--reprimand-color);
      border-color: var(--reprimand-color);
      color: var(--accent-red);
    }

    .reality-split-tracker .tracker-end {
      width: 24px;
      height: 24px;
      border: 2px solid var(--arc-reality);
      border-radius: 50%;
      background: var(--arc-reality);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: white;
    }

    .reality-split-tracker .tracker-end.failed {
      background: var(--accent-red);
      border-color: var(--accent-red);
      color: white;
    }

    .ref-block.现实 .relationships-section {
      margin-top: 0.35rem;
    }

    .ref-block.现实 .relationships-list {
      padding: 0.35rem 0 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .ref-block.现实 .relationship-item {
      margin: 0.35rem 0 0.35rem 0.5rem;
      border-left: 2px solid rgba(218, 165, 32, 0.4);
      flex: 0 0 auto;
      min-height: 0;
      overflow: visible;
    }

    .ref-block.现实 .relationship-item summary {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .ref-block.现实 .relationship-item summary::before {
      display: none;
    }

    .ref-block.现实 .relationship-item .relationship-title-left {
      min-width: 0;
    }

    .ref-block.现实 .relationship-item .relationship-title-right {
      flex-shrink: 0;
    }

    .ref-block.现实 .relationship-content p {
      margin: 0 0 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .ref-block.现实 .relationship-content p:last-child {
      margin-bottom: 0;
    }

    .ref-block.现实 .relationship-benefit-title {
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .ref-block.现实 .relationship-benefit-title .benefit-label {
      color: var(--arc-reality);
    }

    .ref-block.现实 .relationship-actor {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }

    .ref-block.职能 {
      border-color: rgba(196, 30, 58, 0.5);
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .ref-block.职能 .ref-block-title {
      background: rgba(196, 30, 58, 0.15);
      color: var(--arc-competency);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .ref-block.职能 .ref-item summary {
      color: var(--arc-competency);
    }

    .ref-block-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .ref-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin: 0.35rem 0.75rem 0.35rem;
      overflow: hidden;
    }

    .ref-item:first-of-type {
      margin-top: 0.35rem;
    }

    .ref-item:last-child {
      margin-bottom: 0.75rem;
    }

    .ref-item summary {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      list-style: none;
    }

    .ref-item summary::-webkit-details-marker {
      display: none;
    }

    .ref-item summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 5px solid currentColor;
      margin-right: 0.5rem;
      vertical-align: middle;
      transition: transform 0.2s;
    }

    .ref-item[open] summary::before {
      transform: rotate(90deg);
    }

    .ref-item-desc {
      padding: 0 0.75rem 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .ref-item-desc .outcome-label {
      color: var(--accent-red);
      font-weight: 600;
    }

    .ref-block>.ref-item-desc {
      margin: 0.35rem 0.75rem 0.75rem;
    }

    .well-known-wrap {
      padding-top: 0.35rem !important;
      font-size: 0.7rem;
    }

    .well-known-track {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.35rem 0.75rem;
      font-size: inherit;
      color: var(--text-secondary);
    }

    .well-known-intro {
      flex-shrink: 0;
      margin-right: 0.15rem;
    }

    .well-known-label {
      flex-shrink: 0;
    }

    .well-known-boxes {
      display: inline-flex;
      gap: 0.2rem;
    }

    .well-known-box {
      display: inline-block;
      width: 0.9rem;
      height: 0.9rem;
      border: 1px solid rgba(46, 77, 146, 0.5);
      border-radius: 2px;
      background: var(--bg-card);
    }

    .well-known-box.filled {
      background: rgba(46, 77, 146, 0.35);
      border-color: var(--arc-anomaly);
      color: var(--arc-anomaly);
    }

    .item-card {
      background: var(--bg-dark);
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
      box-shadow: 0 0 10px var(--glow-red-soft);
    }

    .item-card details {
      border: none;
    }

    .item-card summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--accent-red);
      text-shadow: 0 0 4px var(--glow-red-soft);
      user-select: none;
    }

    .item-card summary::-webkit-details-marker {
      display: none;
    }

    .item-card summary::before {
      content: '▶';
      display: inline-block;
      margin-right: 0.35rem;
      font-size: 0.7rem;
      transition: transform 0.2s;
    }

    .item-card details[open] summary::before {
      transform: rotate(90deg);
    }

    .item-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: pre-line;
      line-height: 1.5;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    .loading,
    .error {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-secondary);
    }

    .error {
      color: var(--accent-red);
    }

    .no-results {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-secondary);
    }

    .welcome-state {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }

    .welcome-state .welcome-title {
      font-size: clamp(1.25rem, 4vw, 2.5rem);
      font-weight: 600;
      color: var(--text-secondary);
      margin: 0 0 0.5rem 0;
      text-shadow: 0 0 12px var(--glow-red-soft);
    }

    .welcome-state .welcome-title-typing {
      display: inline-block;
      overflow: hidden;
      white-space: nowrap;
      width: 0;
      animation: welcome-title-type 1.6s steps(12) forwards,
                 welcome-title-cursor 0.6s step-end infinite;
      border-right: 0.12em solid var(--accent-red);
    }

    @keyframes welcome-title-type {
      from { width: 0; }
      to { width: 12.2em; }
    }

    @keyframes welcome-title-cursor {
      50% { border-right-color: transparent; }
    }

    .welcome-state .welcome-subtitle {
      font-size: clamp(0.9rem, 2.5vw, 1.25rem);
      font-style: italic;
      color: var(--text-secondary);
      margin: 0 0 clamp(1.5rem, 5vw, 2.5rem) 0;
    }

    .welcome-triangle-wrap {
      position: relative;
      padding: clamp(24px, 8vmin, 48px);
      animation: welcome-triangle-spin 8s linear infinite;
    }

    @keyframes welcome-triangle-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .welcome-triangle-svg {
      display: block;
      width: clamp(100px, 28vmin, 200px);
      height: clamp(100px, 28vmin, 200px);
      overflow: visible;
      filter: drop-shadow(0 0 12px var(--glow-red)) drop-shadow(0 0 24px rgba(196, 30, 58, 0.5));
    }

    .welcome-triangle-svg .triangle {
      fill: var(--accent-red);
      stroke: none;
    }

    .welcome-triangle-svg .ripple-circle {
      fill: none;
      stroke: var(--accent-red);
      stroke-width: 1.5;
      opacity: 0;
      transform-origin: center;
      transform-box: fill-box;
      animation: welcome-ripple-out 2.4s ease-out infinite;
    }

    .welcome-triangle-svg .ripple-circle:nth-child(1) { animation-delay: 0s; }
    .welcome-triangle-svg .ripple-circle:nth-child(2) { animation-delay: 0.4s; }
    .welcome-triangle-svg .ripple-circle:nth-child(3) { animation-delay: 0.8s; }
    .welcome-triangle-svg .ripple-circle:nth-child(4) { animation-delay: 1.2s; }
    .welcome-triangle-svg .ripple-circle:nth-child(5) { animation-delay: 1.6s; }
    .welcome-triangle-svg .ripple-circle:nth-child(6) { animation-delay: 2s; }
    .welcome-triangle-svg .ripple-circle:nth-child(7) { animation-delay: 2.4s; }

    @keyframes welcome-ripple-out {
      0% {
        transform: scale(0.15);
        opacity: 0.7;
      }
      50% {
        opacity: 0.35;
      }
      100% {
        transform: scale(2.4);
        opacity: 0;
      }
    }

    /* Subtle neon pulse */
    @keyframes neon-pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.85;
      }
    }

    .banner-title h1 {
      animation: neon-pulse 3s ease-in-out infinite;
    }

    .sidebar-title {
      animation: neon-pulse 4s ease-in-out infinite;
    }

    .agent-tabs {
      display: none;
    }

    .agent-tab {
      padding: 0.5rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }

    .agent-tab:hover {
      color: var(--text-primary);
    }

    .agent-tab.active {
      background: var(--bg-card);
      color: var(--accent-red);
      border-color: var(--accent-red);
      font-weight: 600;
    }

    .agent-tab-panels {
      display: contents;
    }

    .agent-tab-panel {
      display: contents;
    }

    .agent-tab-panel.hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .banner {
        flex-direction: column;
        align-items: stretch;
        padding: 0.75rem 1rem;
        gap: 0.5rem;
      }

      .banner-title {
        flex-shrink: 0;
      }

      .banner-title h1 {
        font-size: 1.25rem;
      }

      .banner-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }

      .banner-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
        width: 100%;
      }

      .banner-buttons .banner-btn-with-label {
        flex: 1;
        min-width: 0;
        max-width: none;
        width: auto;
        padding: 0;
        gap: 0;
      }

      .banner-buttons .banner-btn-with-label .banner-btn-label {
        display: none;
      }

      .banner-buttons .banner-btn-with-label .banner-btn-cell {
        width: 2.75rem;
        min-width: 2.75rem;
        height: 2.75rem;
        margin: 0 auto;
      }

      .banner-buttons .banner-btn-with-label .banner-btn-icon {
        width: 1.6rem;
        height: 1.6rem;
      }

      .agent-dropdown-wrap {
        max-width: 100%;
      }

      .layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        min-width: unset;
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: row;
        flex-wrap: wrap;
      }

      .sidebar-section {
        flex: 1;
        min-width: 140px;
      }

      .sidebar {
        display: none;
      }

      .banner-ecg {
        display: none;
      }

      .agent-tabs {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem 1rem 0;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
      }

      .agent-tabs .agent-tab {
        white-space: nowrap;
        flex-shrink: 0;
      }

      .main-content {
        flex: 1;
        overflow: auto;
      }

      .agents-grid {
        display: block;
      }

      .agents-grid .agent-card-flip {
        display: none;
      }

      .agents-grid .agent-card-flip.mobile-visible {
        display: block;
      }

      .agent-card {
        overflow: visible;
      }
      .agent-card-inner {
        overflow: visible;
      }
      .agent-card-flip.flipped .agent-card-front {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 0;
        overflow: hidden;
      }
      .agent-card-flip.flipped .agent-card-back {
        position: relative;
        inset: auto;
        overflow: visible !important;
        min-height: 0;
      }

      .agent-card-back .arc-tracks-help {
        font-size: 0.95rem;
        line-height: 1.55;
      }
      .agent-card-back .arc-track-help {
        font-size: 0.88rem;
        line-height: 1.5;
      }
      .agent-card-back .arc-track-name {
        font-size: 0.85rem;
      }
      .agent-card-back .arc-track-bar .tracker-step {
        width: 30px;
        height: 30px;
        min-width: 30px;
        min-height: 30px;
        font-size: 0.8rem;
      }
      .agent-card-back .arc-track-bar .tracker-step .tracker-step-inner {
        font-size: 0.75rem;
      }
    }

    @media (min-width: 1400px) {
      html {
        font-size: 18px;
      }

      .sidebar {
        width: 320px;
        min-width: 320px;
      }

      .agency-news {
        min-height: 140px;
        max-height: 320px;
      }

      .agents-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      }
    }

    @media (min-width: 1800px) {
      html {
        font-size: 20px;
      }

      .sidebar {
        width: 360px;
        min-width: 360px;
      }

      .agency-news {
        min-height: 160px;
        max-height: 360px;
      }

      .agents-grid {
        grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      }
    }
  </style>
</head>

<body>
  <header class="banner">
    <div class="banner-title">
      <div class="banner-triangle"></div>
      <h1>Agency<span class="accent-os">OS</span></h1>
    </div>
    <div class="banner-ecg" aria-hidden="true"></div>
    <div class="banner-controls">
      <div class="agent-dropdown-wrap">
        <button class="agent-dropdown-trigger" id="agentDropdownTrigger">
          <span>选择特工</span>
          <span class="agent-count" id="agentCount">全部</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div class="agent-dropdown-panel" id="agentDropdownPanel"></div>
      </div>
      <div class="banner-buttons" id="bannerButtons">
        <button class="items-list-btn banner-btn-with-label" id="agencyDiceBtn" type="button" aria-label="机构骰子" title="机构骰子">
          <span class="banner-btn-cell"><svg class="banner-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="5" y="5" width="14" height="14" rx="2"/><circle cx="9" cy="9" r="1.2"/><circle cx="15" cy="15" r="1.2"/></svg></span>
          <span class="banner-btn-label">机构骰子</span>
        </button>
        <button class="items-list-btn banner-btn-with-label" id="itemsListBtn" type="button" aria-label="申领物列表" title="申领物列表">
          <span class="banner-btn-cell"><svg class="banner-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></span>
          <span class="banner-btn-label">申领物</span>
        </button>
        <button class="items-list-btn banner-btn-with-label" id="missionArchiveBtn" type="button" aria-label="任务档案库" title="任务档案库">
          <span class="banner-btn-cell"><svg class="banner-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span>
          <span class="banner-btn-label">任务档案</span>
        </button>
        <button class="items-list-btn banner-btn-with-label" id="emailInboxBtn" type="button" aria-label="机构邮箱" title="机构邮箱">
          <span class="banner-btn-cell banner-btn-cell-with-badge">
            <svg class="banner-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <span class="banner-email-badge" id="emailInboxBadge" aria-hidden="true">1</span>
          </span>
          <span class="banner-btn-label">机构邮箱</span>
        </button>
        <button class="siphon-btn banner-btn-with-label" id="siphonBtn" type="button" aria-label="Siphon的商店" title="Siphon的商店">
          <span class="banner-btn-cell"><svg class="siphon-eye-icon banner-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></span>
          <span class="banner-btn-label">U???</span>
        </button>
      </div>
    </div>
  </header>

  <div class="modal-overlay" id="missionArchiveModalOverlay">
    <div class="modal mission-archive-modal" id="missionArchiveModal">
      <div class="modal-header">
        <h3 class="modal-title mission-archive-title">任务档案库</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body" id="missionArchiveBody">
        <div class="mission-archive-list" id="missionArchiveList"></div>
        <div class="mission-archive-detail" id="missionArchiveDetail" style="display:none">
          <div class="mission-report" id="missionReportContent"></div>
          <button type="button" class="mission-back-btn" id="missionArchiveBack">← 返回列表</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="itemsListModalOverlay">
    <div class="modal items-list-modal" id="itemsListModal">
      <div class="modal-header">
        <h3 class="modal-title">申领物列表</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body" id="itemsListModalBody">
        <div class="items-list-loading">加载中…</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="agencyDiceModalOverlay">
    <div class="modal agency-dice-modal" id="agencyDiceModal">
      <div class="modal-header">
        <h3 class="modal-title">机构骰子</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body agency-dice-body" id="agencyDiceBody">
        <p class="agency-dice-hint">点击任意处掷骰</p>
        <div class="dice-container" id="agencyDiceContainer">
          <div class="d4-die" data-value="1"><span class="d4-triangle"></span><span class="d4-value">1</span></div>
          <div class="d4-die" data-value="1"><span class="d4-triangle"></span><span class="d4-value">1</span></div>
          <div class="d4-die" data-value="1"><span class="d4-triangle"></span><span class="d4-value">1</span></div>
          <div class="d4-die" data-value="1"><span class="d4-triangle"></span><span class="d4-value">1</span></div>
          <div class="d4-die" data-value="1"><span class="d4-triangle"></span><span class="d4-value">1</span></div>
          <div class="d4-die" data-value="1"><span class="d4-triangle"></span><span class="d4-value">1</span></div>
        </div>
        <p class="agency-dice-success" id="agencyDiceSuccess">成功：0</p>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="jointAssessmentModalOverlay">
    <div class="modal joint-assessment-modal" id="jointAssessmentModal">
      <div class="modal-header">
        <h3 class="modal-title joint-assessment-title">机密文件-未授权</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body">
        <div class="ta-report" id="jointAssessmentReport"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="siphonModalOverlay">
    <div class="modal siphon-modal" id="siphonModal">
      <div class="siphon-floating-pic" id="siphonFloatingPic" aria-hidden="true">
        <img src="assets/siphon.png" alt="">
      </div>
      <div class="modal-header siphon-modal-header">
        <h3 class="modal-title siphon-modal-title" id="siphonModalTitle">正在尝试非法连接...</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body" id="siphonModalBody">
        <div id="siphonStep1">
          <p class="siphon-help">请输入密码</p>
          <input type="password" id="siphonPassword" class="siphon-input" placeholder="密码" autocomplete="off">
          <button type="button" class="siphon-submit-btn" id="siphonSubmitBtn">连接</button>
        </div>
        <div id="siphonStep2" style="display:none">
          <p id="siphonErrorMsg" class="siphon-error-msg" style="display:none"><span class="siphon-error-icon" aria-hidden="true">!</span> 访问被拒绝。机构安保协议已记录此事件。</p>
          <div id="siphonStoreContent" class="siphon-store-content" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="emailReminderModalOverlay">
    <div class="modal email-reminder-modal">
      <div class="email-reminder-header">
        <span class="email-reminder-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        </span>
        <div class="email-reminder-header-text">
          <h3 class="email-reminder-title" id="emailReminderTitle">新邮件提醒</h3>
          <p class="email-reminder-subtitle" id="emailReminderSubtitle">您有一封新邮件</p>
        </div>
        <button class="modal-close" type="button" aria-label="关闭" id="emailReminderClose">×</button>
      </div>
      <div class="email-reminder-body">
        <div id="emailReminderHasMail" class="email-reminder-has-mail">
          <button type="button" class="email-reminder-open-btn" id="emailReminderOpenBtn">
            <span class="email-reminder-open-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </span>
            打开邮件
          </button>
        </div>
        <p id="emailReminderNoMail" class="email-reminder-no-mail" style="display:none">暂无邮件</p>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="emailContentModalOverlay">
    <div class="modal email-content-modal">
      <div class="email-content-header">
        <span class="email-content-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        </span>
        <div class="email-content-header-inner">
          <h3 class="email-content-title" id="emailContentTitle">邮件</h3>
          <div class="email-content-meta">
            <span class="email-content-from">发件人：机构系统</span>
          </div>
        </div>
        <button class="modal-close" type="button" aria-label="关闭" id="emailContentClose">×</button>
      </div>
      <div class="email-content-divider"></div>
      <div class="email-content-body-wrap">
        <div class="email-content-body" id="emailContentBody"></div>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section agency-stats-section">
        <div class="sidebar-title">机构状态</div>
        <div class="agency-stats">
          <div class="agency-stat">
            <span class="label">混沌值</span>
            <span class="value" id="chaosValue">—</span>
          </div>
          <div class="agency-stat">
            <span class="label">散逸端</span>
            <span class="value" id="looseEnds">—</span>
          </div>
          <div class="agency-stat">
            <span class="label">现实稳定度</span>
            <span class="value" id="realityStability">—</span>
          </div>
          <div class="agency-stat">
            <span class="label">分部名</span>
            <span class="value">悉尼</span>
          </div>
        </div>
      </div>
      <div class="sidebar-section gm-profile-section">
        <div class="sidebar-title">机构总经理</div>
        <div class="gm-profile">
          <div class="gm-profile-frame">
            <img data-src="assets/gm-profile.png"
              src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="机构总经理"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
            <div class="gm-profile-placeholder"
              style="display:none; background:var(--bg-dark); align-items:center; justify-content:center; color:var(--text-secondary); font-size:0.8rem;">
              请添加 assets/gm-profile.png</div>
          </div>
          <div class="gm-info">
            <div class="gm-info-row"><span class="label">姓名：</span><span id="gmName"></span></div>
            <div class="gm-info-row"><span class="label">AKA：</span><span id="gmAka"></span></div>
          </div>
        </div>
        <button type="button" class="glitch-sos-btn" id="glitchSosBtn" aria-label="内部文件泄露SOS"><span class="glitch-text"
            data-text="内部文件泄露SOS">内部文件泄露SOS</span></button>
      </div>
      <div class="sidebar-section agency-news agency-news-section">
        <div class="sidebar-title">机构动态</div>
        <div class="agency-news-content" id="agencyNews">
          <span class="agency-news-placeholder">暂无动态</span>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div id="content">
        <div class="loading">加载中…</div>
      </div>
    </main>
  </div>

  <script>
    const BASE = (window.location.pathname.replace(/\/index\.html$/, '').replace(/\/$/, '') || '.') + '/data';

    /** Playwall document ref numbers on certain boxes (0-based index) for each track. 30 boxes per track. */
    /** Playwall refs: key = 0-based box index (user list was 1-based: position 1 = index 0). */
    const WALL_TRACK_REFS = {
      职能: { 2: 'A3', 5: 'D4', 8: 'G3', 11: 'J3', 14: 'N3', 17: 'Q3', 20: 'T3', 23: 'W8', 26: 'Y2' },
      现实: { 0: 'C4', 3: 'L11', 7: 'E2', 9: 'O4', 13: 'T6', 16: 'V2', 18: 'X3', 20: 'H5', 23: 'E3' },
      异常: { 0: 'H4', 1: 'H3', 4: 'U2', 6: 'X2', 10: 'N1', 12: 'Q2', 16: 'L10', 18: 'G8', 22: 'A7' }
    };

    async function fetchJSON(filename) {
      const res = await fetch(`${BASE}/${filename}`);
      if (!res.ok) throw new Error(`加载失败: ${res.status}`);
      return res.json();
    }

    let allAgents = [];
    let selectedAgentIndices = new Set();
    let statusesData = null;
    const MAX_SELECTED_AGENTS = 4;

    const AGENCY_RATINGS = [
      '评级良好',
      '有待改进',
      '亟待改进',
      '那个员工',
      '独自午餐',
      '被动攻击的目标',
      '未被邀请参加派对',
      '我们曾对你寄予厚望',
      '尚有改变的时间',
      '请不要这么做'
    ];

    function getAgencyRating(申诫) {
      const n = Math.max(0, parseInt(申诫, 10) || 0);
      return n >= 10 ? '冷冻酸奶室权限已撤销' : (AGENCY_RATINGS[n] ?? '—');
    }

    function getAgencyRatingTier(申诫) {
      const n = Math.max(0, parseInt(申诫, 10) || 0);
      if (n === 0) return 'tier-0';
      if (n <= 3) return 'tier-1-3';
      if (n <= 6) return 'tier-4-6';
      if (n <= 9) return 'tier-7-9';
      return 'tier-10';
    }

    const AGENCY_TITLES = ['见习生', '专员', '高级专员', '助理总监', '总监', '地区总监', '副总裁', '高级副总裁', '执行副总裁', '主席'];
    function getAgencyTitleFromCompetencyTrack(agent) {
      const wallTracks = agent.wallTracks || {};
      const 职能 = wallTracks.职能 || { marked: 0, struck: 0 };
      const marked = Math.max(0, parseInt(职能.marked, 10) || 0);
      const index = marked <= 1 ? 0 : Math.min(1 + Math.floor((marked - 2) / 3), AGENCY_TITLES.length - 1);
      return AGENCY_TITLES[index];
    }

    function buildWellKnownBoxes(value) {
      const n = Math.min(3, Math.max(0, parseInt(value, 10) || 0));
      let html = '';
      for (let i = 0; i < 3; i++) {
        html += `<span class="well-known-box${i < n ? ' filled' : ''}"></span>`;
      }
      return html;
    }

    function buildRefAnomalyHtml(agent) {
      const abilities = agent.arc?.异常?.abilities || [];
      if (abilities.length === 0) return '<div class="ref-item-desc">无</div>';
      return abilities.map(ab => {
        const wk = ab.wellKnown || { a: 0, b: 0 };
        const aVal = Math.min(3, Math.max(0, parseInt(wk.a, 10) || 0));
        const bVal = Math.min(3, Math.max(0, parseInt(wk.b, 10) || 0));
        const wellKnownHtml = `
          <div class="well-known-track">
            <span class="well-known-intro">为人所知</span>
            <span class="well-known-label">A</span>
            <div class="well-known-boxes">${buildWellKnownBoxes(aVal)}</div>
            <span class="well-known-label">B</span>
            <div class="well-known-boxes">${buildWellKnownBoxes(bVal)}</div>
          </div>`;
        return `
        <details class="ref-item">
          <summary>
            <span class="ability-summary-inner">
              <span class="ability-name">${escapeHtml(ab.name || '')}</span>
              ${ab.已练习 ? '<span class="ability-proficient">(已练习)</span>' : ''}
            </span>
          </summary>
          <div class="ref-item-desc">${formatDescriptionWithOutcomes(ab.description || '')}</div>
          <div class="ref-item-desc well-known-wrap">${wellKnownHtml}</div>
        </details>
      `;
      }).join('');
    }

    function buildRealitySplitTrackerHtml(割裂进度) {
      const n = Math.min(4, Math.max(0, parseInt(割裂进度, 10) || 0));
      let steps = '<div class="tracker-start"></div><div class="tracker-connector"></div>';
      for (let i = 1; i <= 4; i++) {
        const filled = i <= n;
        const warning = filled && i === 3;
        steps += `<div class="tracker-step${filled ? ' filled' : ''}${warning ? ' warning' : ''}">${i}</div>`;
        if (i < 4) steps += '<div class="tracker-connector"></div>';
      }
      steps += '<div class="tracker-connector"></div>';
      steps += `<div class="tracker-end${n >= 4 ? ' failed' : ''}">✕</div>`;
      return `<div class="reality-split-tracker">${steps}</div>`;
    }

    function buildArcTrackersHtml(agent) {
      const wallTracks = agent.wallTracks || {
        异常: { marked: 0, struck: 0 },
        现实: { marked: 0, struck: 0 },
        职能: { marked: 0, struck: 0 }
      };
      const TRACK_NAMES = ['职能', '现实', '异常'];
      const NUM_BOXES = 30;
      const ARC_TRACKS_HELP_GENERAL = '每当你标记一格时，你必须从所有其他记录条的末尾划掉一格。';
      const ARC_TRACK_HELP = {
        职能: '每当你在职能记录条上标记一格时，将任意一项资质的「资质保证上限」提升1点，最高不超过9点。<br>当你获得任务MVP时，在你的职能记录条上标记1格，且无需从其他记录条上移除一格。',
        现实: '每当你在现实记录条上标记一格时，将你与任意一段「关系」的「连结」提升1点。<br>当你既未获得任务MVP也未进入察看期时，你可以将你与任意一段关系的连结提升1点。',
        异常: '每当你在异常记录条上标记一格时，选择一项：练习或为人所知。<br>• 练习：在任意一项异常能力上标记「已练习」。<br>• 为人所知：从一项异常能力中移除「已练习」标记，并向你的团队提出该能力的问题。在获得最多票数的答案轨道上做标记，然后获得所有已解锁的能力。<br>当你进入察看期时，在你的异常记录条上标记1格，且无需从其他记录条上移除一格。'
      };
      function boxState(name, i) {
        const track = wallTracks[name] || { marked: 0, struck: 0 };
        const marked = Math.max(0, parseInt(track.marked, 10) || 0);
        const struck = Math.max(0, parseInt(track.struck, 10) || 0);
        const filled = i < marked;
        const struckFromEnd = i >= NUM_BOXES - struck;
        return { filled, struck: struckFromEnd };
      }
      function oneBox(name, i) {
        const refs = WALL_TRACK_REFS[name] || {};
        const ref = refs[i];
        const { filled, struck } = boxState(name, i);
        const cls = ['tracker-step', filled ? 'filled' : '', struck ? 'struck' : '', ref ? 'ref' : ''].filter(Boolean).join(' ');
        const inner = ref ? escapeHtml(ref) : '';
        return `<div class="${cls}" data-idx="${i}"><span class="tracker-step-inner">${inner}</span></div>`;
      }
      function bar(name) {
        let cells = '';
        for (let i = 0; i < NUM_BOXES; i++) {
          const conn = i < NUM_BOXES - 1 ? '<div class="arc-track-connector h" aria-hidden="true"></div>' : '';
          cells += `<div class="arc-track-cell">${oneBox(name, i)}${conn}</div>`;
        }
        return `
          <div class="arc-track ${name}">
            <div class="arc-track-name">${name}</div>
            <div class="arc-track-help">${ARC_TRACK_HELP[name] || ''}</div>
            <div class="arc-track-bar">${cells}</div>
          </div>`;
      }
      return `
        <div class="agent-card-back-tracks">
          <div class="agent-card-back-title">轨道</div>
          <button type="button" class="agent-track-btn agent-track-btn-back">特工</button>
          <p class="arc-tracks-help">${ARC_TRACKS_HELP_GENERAL}</p>
          ${TRACK_NAMES.map(bar).join('')}
        </div>`;
    }

    function buildRefRealityHtml(agent) {
      const arc = agent.arc?.现实;
      if (!arc) return '<div class="ref-item-desc">无</div>';
      let html = '';
      if (arc.现实触发器) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.现实触发器.name || '')}</summary>
          <div class="ref-item-desc">${formatDescriptionWithOutcomes(arc.现实触发器.description || '')}</div>
        </details>`;
      }
      if (arc.过载解除) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.过载解除.name || '')}</summary>
          <div class="ref-item-desc">${formatDescriptionWithOutcomes(arc.过载解除.description || '')}</div>
        </details>`;
      }
      html += `<details class="ref-item">
        <summary>割裂进度</summary>
        <div class="ref-item-desc">${buildRealitySplitTrackerHtml(arc.割裂进度 ?? 0)}</div>
      </details>`;
      html += buildRelationshipsHtml(arc.关系 || []);
      return html || '<div class="ref-item-desc">无</div>';
    }

    function buildRelationshipsHtml(关系) {
      if (!关系 || 关系.length === 0) return '';
      const itemsHtml = 关系.map(rel => {
        const name = escapeHtml(rel.name || '');
        const actor = rel.actor ? escapeHtml(rel.actor) : '';
        const closeness = Math.min(9, Math.max(1, parseInt(rel.closeness, 10) || 0));
        const activeText = rel.benefitActive ? '已激活' : '未激活';
        const desc = escapeHtml(rel.description || '');
        const benefit = escapeHtml(rel.benefit || '');
        const benefitDesc = escapeHtml(rel.benefitDescription || '');
        let content = actor ? `<p class="relationship-actor">扮演：${actor}</p>` : '';
        content += desc ? `<p class="relationship-desc">${desc}</p>` : '';
        if (benefit || benefitDesc) {
          content += `<p class="relationship-benefit-title"><span class="benefit-label">连结加成</span>${benefit ? ' — ' + benefit : ''}</p>`;
          if (benefitDesc) content += `<p class="relationship-benefit-desc">${benefitDesc}</p>`;
        }
        return `<details class="ref-item relationship-item">
          <summary><span class="relationship-title-left">${name} 连结${closeness}</span><span class="relationship-title-right">${activeText}</span></summary>
          <div class="ref-item-desc relationship-content">${content || '<p>—</p>'}</div>
        </details>`;
      }).join('');
      return `<details class="ref-item relationships-section">
        <summary>关系</summary>
        <div class="relationships-list">${itemsHtml}</div>
      </details>`;
    }

    function buildRefCompetencyHtml(agent) {
      const arc = agent.arc?.职能;
      if (!arc) return '<div class="ref-item-desc">无</div>';
      let html = '';
      if (arc.首要指令) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.首要指令.name || '')}</summary>
          <div class="ref-item-desc">${formatDescriptionWithOutcomes(arc.首要指令.description || '')}</div>
        </details>`;
      }
      if (arc.许可行为 && arc.许可行为.length) {
        html += `<details class="ref-item">
          <summary>许可行为</summary>
          <div class="ref-item-desc">${arc.许可行为.map(p => '• ' + escapeHtml(p)).join('\n')}</div>
        </details>`;
      }
      return html || '<div class="ref-item-desc">无</div>';
    }

    function renderAgent(agent) {
      const arc = agent.arc || {};
      const arcLabels = [
        { type: '异常', choice: arc.异常?.choice, letter: 'A' },
        { type: '现实', choice: arc.现实?.choice, letter: 'R' },
        { type: '职能', choice: arc.职能?.choice, letter: 'C' }
      ];
      const arcBadgesHtml = arcLabels.map(({ type, choice, letter }) => `
        <span class="arc-badge ${type}">
          <span class="arc-badge-icon">${letter}</span>
          <span>${escapeHtml(choice || '—')}</span>
        </span>
      `).join('');

      const scoresHtml = `
        <div class="agent-scores">
          <div class="score 嘉奖"><span class="score-icon">★</span>嘉奖 <strong>${agent.嘉奖 ?? 0}</strong></div>
          <div class="score 察看期"><span class="score-icon">▣</span>察看期 <strong>${agent.察看期 ?? 0}</strong></div>
          <div class="score 申诫"><span class="score-icon">✗</span>申诫 <strong>${agent.申诫 ?? 0}</strong></div>
          <div class="score mvp"><span class="score-icon">◆</span>MVP <strong>${agent.mvp ?? agent.任务MVP ?? 0}</strong></div>
        </div>
      `;

      const qaQualities = ['专注', '共情', '气场', '欺瞒', '主动', '专业', '活力', '坚毅', '诡秘'];
      const qa = agent.qa || {};
      const qaHtml = qaQualities.map(q => {
        const val = qa[q] != null ? Number(qa[q]) : 0;
        return `
        <div class="qa-item">
          <span>${q}</span>
          <span class="value">${val}</span>
        </div>
      `;
      }).join('');

      const itemsHtml = (agent.申领物 || []).map(item => `
        <div class="item-card">
          <details>
            <summary>${escapeHtml(item.name)}</summary>
            <div class="item-desc">${escapeHtml(item.description || '')}</div>
          </details>
        </div>
      `).join('');

      const profilePicSrc = agent.profilePic || (agent.id ? `assets/${agent.id}.PNG` : null);
      const profilePicHtml = profilePicSrc
        ? `<div class="agent-profile-slot"><img class="agent-profile-pic" src="${escapeHtml(profilePicSrc)}" alt="${escapeHtml(agent.name || '')}" onerror="if(!this.dataset.retried){this.dataset.retried=1;this.src=this.src.replace(/\\.PNG$/i,'.png');}else{this.style.display='none';this.nextElementSibling.style.display='flex';}" /><div class="agent-profile-placeholder" style="display:none;">头像</div></div>`
        : `<div class="agent-profile-slot"><div class="agent-profile-placeholder">头像</div></div>`;

      const badgesHtml = [];
      if (agent.flag) badgesHtml.push('<img class="agent-badge-img" src="assets/flag.png" alt="flag" />');
      if (agent.socks) badgesHtml.push('<img class="agent-badge-img" src="assets/socks.png" alt="socks" />');
      const badgesEl = badgesHtml.length ? `<div class="agent-badges">${badgesHtml.join('')}</div>` : '';

      const cardInner = `
        <div class="agent-card">
          <button type="button" class="agent-track-btn" aria-label="翻转查看轨道">轨道</button>
          ${badgesEl}
          <div class="agent-card-header">
            <div class="agent-header-top">
              ${profilePicHtml}
              <div class="agent-name-row">
                <div>
                  <div class="agent-name">${escapeHtml(agent.name || '未命名特工')}</div>
                  ${agent.aka ? `<div class="agent-aka">${escapeHtml(agent.aka)}</div>` : ''}
                  <div class="agent-title"><span class="label">机构头衔：</span>${escapeHtml(getAgencyTitleFromCompetencyTrack(agent))}</div>
                  <div class="agent-agency-rating"><span class="label">机构评级：</span><span class="rating-value ${getAgencyRatingTier(agent.申诫 ?? 0)}">${getAgencyRating(agent.申诫 ?? 0)}</span></div>
                </div>
                ${scoresHtml}
              </div>
            </div>
            <div class="arc-badges">${arcBadgesHtml}</div>
          </div>
          <div class="agent-body">
            <div class="section">
              <div class="section-title">资质保证 (QA)</div>
              <div class="qa-grid">${qaHtml}</div>
            </div>
            <div class="reference-section">
              <div class="ref-block 异常">
                <div class="ref-block-title">异常 — ${escapeHtml(arc.异常?.choice || '—')}</div>
                ${buildRefAnomalyHtml(agent)}
              </div>
              <div class="ref-block 现实">
                <div class="ref-block-title">现实 — ${escapeHtml(arc.现实?.choice || '—')}</div>
                ${buildRefRealityHtml(agent)}
              </div>
              <div class="ref-block 职能">
                <div class="ref-block-title">职能 — ${escapeHtml(arc.职能?.choice || '—')}</div>
                ${buildRefCompetencyHtml(agent)}
              </div>
            </div>
            ${itemsHtml ? `
            <div class="section">
              <div class="section-title">申领物</div>
              ${itemsHtml}
            </div>
            ` : ''}
          </div>
        </div>`;

      const backHtml = buildArcTrackersHtml(agent);
      return `
        <div class="agent-card-flip">
          <div class="agent-card-inner">
            <div class="agent-card-front">${cardInner}</div>
            <div class="agent-card-back">${backHtml}</div>
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDescriptionWithOutcomes(str) {
      if (!str) return '';
      const escaped = escapeHtml(str);
      return escaped
        .replace(/成功时/g, '<span class="outcome-label">成功时</span>')
        .replace(/失败时/g, '<span class="outcome-label">失败时</span>');
    }

    function renderAgentSelect() {
      const panel = document.getElementById('agentDropdownPanel');
      const trigger = document.getElementById('agentDropdownTrigger');
      const countEl = document.getElementById('agentCount');

      panel.innerHTML = `<div class="agent-checkboxes">${allAgents.map((a, i) => `
        <label class="agent-checkbox">
          <input type="checkbox" data-index="${i}" ${selectedAgentIndices.has(i) ? 'checked' : ''} ${!selectedAgentIndices.has(i) && selectedAgentIndices.size >= MAX_SELECTED_AGENTS ? 'disabled' : ''} />
          <span>${escapeHtml(a.name || '未命名')}${a.aka ? ` (${escapeHtml(a.aka)})` : ''}</span>
        </label>
      `).join('')}</div>`;

      panel.querySelectorAll('.agent-checkbox input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', (e) => {
          e.stopPropagation();
          const i = parseInt(cb.dataset.index);
          if (cb.checked) {
            if (selectedAgentIndices.size < MAX_SELECTED_AGENTS) {
              selectedAgentIndices.add(i);
            }
          } else {
            selectedAgentIndices.delete(i);
          }
          updateAgentCount();
          renderAgentSelect();
          renderContent();
        });
      });

      trigger.onclick = (e) => {
        e.stopPropagation();
        panel.classList.toggle('open');
      };

      if (!trigger._dropdownBound) {
        trigger._dropdownBound = true;
        document.addEventListener('click', (e) => {
          const wrap = document.querySelector('.agent-dropdown-wrap');
          if (wrap && !wrap.contains(e.target)) {
            panel.classList.remove('open');
          }
        });
      }

      function updateAgentCount() {
        const n = selectedAgentIndices.size;
        countEl.textContent = n > 0 ? `(${n})` : '';
      }
      updateAgentCount();
    }

    function renderContent() {
      const content = document.getElementById('content');
      const hasSelection = selectedAgentIndices.size > 0;

      if (allAgents.length === 0) {
        content.innerHTML = '<div class="no-results">暂无特工数据</div>';
        return;
      }

      if (!hasSelection) {
        const rippleRadii = [12, 20, 28, 36, 44, 52, 60];
        const ripples = rippleRadii.map(r => `<circle class="ripple-circle" cx="50" cy="50" r="${r}"/>`).join('');
        content.innerHTML = `
          <div class="welcome-state">
            <p class="welcome-title"><span class="welcome-title-typing"><span class="welcome-title-typing-inner">欢迎使用Agency<span class="accent-os">OS</span></span></span></p>
            <p class="welcome-subtitle">请选择特工以继续</p>
            <div class="welcome-triangle-wrap">
              <svg class="welcome-triangle-svg" viewBox="0 0 100 100" aria-hidden="true">
                ${ripples}
                <polygon class="triangle" points="50,12 88,80 12,80"/>
              </svg>
            </div>
          </div>`;
        return;
      }

      const indices = [...selectedAgentIndices].sort((a, b) => a - b);
      const agentIndexPairs = indices.map(i => ({ agent: allAgents[i], index: i })).filter(p => p.agent);

      const showTabs = window.matchMedia('(max-width: 768px)').matches;
      const tabsHtml = showTabs ? agentIndexPairs.map((p, tabIdx) => {
        const label = p.agent.aka || p.agent.name || '未命名';
        const displayLabel = label.length > 3 ? label.slice(0, 3) + '…' : label;
        const titleAttr = label.length > 3 ? ` title="${escapeHtml(label)}"` : '';
        return `<button type="button" class="agent-tab ${tabIdx === 0 ? 'active' : ''}" data-tab-index="${tabIdx}" data-agent-index="${p.index}"${titleAttr}>${escapeHtml(displayLabel)}</button>`;
      }).join('') : '';

      const cardsHtml = agentIndexPairs.map((p, i) => {
        const card = renderAgent(p.agent);
        return card.replace('<div class="agent-card-flip">', `<div class="agent-card-flip" data-agent-index="${p.index}" data-tab-index="${i}">`);
      }).join('');

      content.innerHTML = `
        <div class="agent-tabs">${tabsHtml}</div>
        <div class="agents-grid">${cardsHtml}</div>
      `;

      if (showTabs) {
        content.querySelectorAll('.agent-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabIndex = parseInt(tab.dataset.tabIndex);
            content.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            content.querySelectorAll('.agents-grid .agent-card-flip').forEach(card => {
              const cardTabIdx = parseInt(card.dataset.tabIndex);
              card.classList.toggle('mobile-visible', cardTabIdx === tabIndex);
            });
          });
        });
        content.querySelectorAll('.agents-grid .agent-card-flip').forEach((card, i) => {
          card.classList.toggle('mobile-visible', i === 0);
        });
      }
    }

    async function load() {
      const content = document.getElementById('content');
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      try {
        const data = await fetchJSON('statuses.json');
        statusesData = data;

        if (!isMobile) {
          document.getElementById('chaosValue').textContent = data.agency?.混沌值 ?? '—';
          document.getElementById('looseEnds').textContent = data.agency?.散逸端 ?? '—';

          function updateRealityStability() {
            const pct = Math.floor(Math.random() * 21) + 75;
            document.getElementById('realityStability').textContent = pct + '%';
          }
          updateRealityStability();
          setInterval(updateRealityStability, 1000);

          const newsEl = document.getElementById('agencyNews');
          const newsArr = data.agency?.news;
          if (Array.isArray(newsArr) && newsArr.length > 0) {
            const sorted = [...newsArr].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            newsEl.innerHTML = sorted.map(item => `
              <div class="news-item">
                <div class="news-item-date">${escapeHtml(item.date || '')}</div>
                <div>${escapeHtml(item.text || '')}</div>
              </div>
            `).join('');
          } else {
            newsEl.innerHTML = '<span class="agency-news-placeholder">暂无动态</span>';
          }

          const gmImg = document.querySelector('.gm-profile-frame img[data-src]');
          if (gmImg && gmImg.dataset.src) gmImg.src = gmImg.dataset.src;
          const gmNameEl = document.getElementById('gmName');
          const gmAkaEl = document.getElementById('gmAka');
          if (gmNameEl) gmNameEl.textContent = data.gm?.name ?? '';
          if (gmAkaEl) gmAkaEl.textContent = data.gm?.aka ?? '';
        }

        allAgents = Array.isArray(data.agents) ? data.agents : [];
        renderAgentSelect();
        renderContent();
        if (!content._arcTrackBound) {
          content._arcTrackBound = true;
          content.addEventListener('click', function (e) {
            const flip = e.target.closest('.agent-card-flip');
            if (!flip) return;
            const idx = parseInt(flip.dataset.agentIndex, 10);
            if (Number.isNaN(idx)) return;
            const agent = allAgents[idx];
            if (!agent) return;
            if (e.target.closest('.agent-track-btn')) {
              flip.classList.toggle('flipped');
            }
          });
        }
        fetchJSON('inMail.json').then(inData => {
          const email = inData?.email;
          if (email && typeof email === 'object' && (email.title || email.content)) {
            window._currentInMail = email;
          } else {
            window._currentInMail = null;
          }
          updateEmailBadge();
        }).catch(() => { updateEmailBadge(); });
      } catch (err) {
        content.innerHTML = `<div class="error">${escapeHtml(err.message)}</div>`;
      }
    }

    function openItemsListModal() {
      document.getElementById('itemsListModalOverlay').classList.add('open');
      const bodyEl = document.getElementById('itemsListModalBody');
      bodyEl.innerHTML = '<div class="items-list-loading">加载中…</div>';
      fetchJSON('items.json')
        .then(data => {
          const items = data?.items || [];
          if (items.length === 0) {
            bodyEl.innerHTML = '<div class="items-list-loading">暂无申领物</div>';
            return;
          }
          bodyEl.innerHTML = items.map(item => `
            <details class="items-list-item">
              <summary>
                <span class="item-title">${escapeHtml(item.name || '')}</span>
                <span class="item-price">${item.price != null ? item.price + ' 嘉奖' : '—'}</span>
              </summary>
              <div class="item-desc">${escapeHtml(item.description || '')}</div>
            </details>
          `).join('');
        })
        .catch(() => {
          bodyEl.innerHTML = '<div class="items-list-loading">加载失败</div>';
        });
    }

    function closeItemsListModal() {
      document.getElementById('itemsListModalOverlay').classList.remove('open');
    }

    const SIPHON_PASSWORD = 'x2';

    const siphonModalTitleEl = document.getElementById('siphonModalTitle');
    function openSiphonModal() {
      document.getElementById('siphonModalOverlay').classList.add('open');
      siphonModalTitleEl.textContent = '正在尝试非法连接...';
      document.getElementById('siphonStep1').style.display = '';
      document.getElementById('siphonStep2').style.display = 'none';
      document.getElementById('siphonPassword').value = '';
      document.getElementById('siphonErrorMsg').style.display = 'none';
      document.getElementById('siphonStoreContent').style.display = 'none';
      document.getElementById('siphonStoreContent').innerHTML = '';
      document.getElementById('siphonFloatingPic').classList.remove('visible');
    }

    function closeSiphonModal() {
      document.getElementById('siphonModalOverlay').classList.remove('open');
    }

    document.getElementById('siphonBtn').addEventListener('click', openSiphonModal);
    document.getElementById('siphonModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'siphonModalOverlay') closeSiphonModal();
    });
    document.getElementById('siphonModal').querySelector('.modal-close').addEventListener('click', closeSiphonModal);

    const INMAIL_SEEN_KEY = 'agencyOS_inMail_seen';
    function inMailSeen() {
      try { return sessionStorage.getItem(INMAIL_SEEN_KEY) === '1'; } catch (e) { return false; }
    }
    function setInMailSeen() {
      try { sessionStorage.setItem(INMAIL_SEEN_KEY, '1'); } catch (e) {}
    }
    function updateEmailBadge() {
      const badge = document.getElementById('emailInboxBadge');
      if (!badge) return;
      const hasMail = !!(window._currentInMail && (window._currentInMail.title || window._currentInMail.content));
      if (hasMail && !inMailSeen()) {
        badge.classList.add('visible');
      } else {
        badge.classList.remove('visible');
      }
    }
    function openEmailModal() {
      const hasMail = !!(window._currentInMail && (window._currentInMail.title || window._currentInMail.content));
      const seen = inMailSeen();
      const titleEl = document.getElementById('emailReminderTitle');
      const subtitleEl = document.getElementById('emailReminderSubtitle');
      const hasMailEl = document.getElementById('emailReminderHasMail');
      const noMailEl = document.getElementById('emailReminderNoMail');
      if (hasMail && !seen) {
        setInMailSeen();
        updateEmailBadge();
        if (titleEl) titleEl.textContent = '新邮件提醒';
        if (subtitleEl) subtitleEl.textContent = '您有一封新邮件';
        if (hasMailEl) hasMailEl.style.display = '';
        if (noMailEl) noMailEl.style.display = 'none';
      } else {
        if (titleEl) titleEl.textContent = '机构邮箱';
        if (subtitleEl) subtitleEl.textContent = '';
        if (hasMailEl) hasMailEl.style.display = 'none';
        if (noMailEl) noMailEl.style.display = 'block';
      }
      document.getElementById('emailReminderModalOverlay').classList.add('open');
    }
    function closeEmailReminderModal() {
      document.getElementById('emailReminderModalOverlay').classList.remove('open');
    }
    function closeEmailContentModal() {
      document.getElementById('emailContentModalOverlay').classList.remove('open');
    }
    document.getElementById('emailInboxBtn').addEventListener('click', openEmailModal);
    document.getElementById('emailReminderClose').addEventListener('click', closeEmailReminderModal);
    document.getElementById('emailReminderModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'emailReminderModalOverlay') closeEmailReminderModal();
    });
    document.getElementById('emailReminderOpenBtn').addEventListener('click', () => {
      closeEmailReminderModal();
      const email = window._currentInMail;
      if (email) {
        document.getElementById('emailContentTitle').textContent = email.title || '邮件';
        document.getElementById('emailContentBody').textContent = email.content || '';
        document.getElementById('emailContentModalOverlay').classList.add('open');
      }
    });
    document.getElementById('emailContentClose').addEventListener('click', closeEmailContentModal);
    document.getElementById('emailContentModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'emailContentModalOverlay') closeEmailContentModal();
    });

    document.getElementById('siphonSubmitBtn').addEventListener('click', () => {
      const input = document.getElementById('siphonPassword');
      const pwd = (input.value || '').trim().toLowerCase();
      document.getElementById('siphonStep1').style.display = 'none';
      document.getElementById('siphonStep2').style.display = '';
      const errorEl = document.getElementById('siphonErrorMsg');
      const contentEl = document.getElementById('siphonStoreContent');
      if (pwd !== SIPHON_PASSWORD.toLowerCase()) {
        errorEl.style.display = 'block';
        contentEl.style.display = 'none';
        contentEl.innerHTML = '';
        return;
      }
      errorEl.style.display = 'none';
      contentEl.style.display = 'block';
            const siphonTitle = 'Siphon的商店';
      siphonModalTitleEl.innerHTML = '<span class="siphon-store-title-altered">' + [...siphonTitle].map((char, i) => `<span class="siphon-store-char" style="animation-delay: ${i * 0.09}s">${escapeHtml(char)}</span>`).join('') + '</span>';
      contentEl.innerHTML = '<div class="items-list-loading">加载中…</div>';
      const siphonQuotes = [
        '秩序是强者的谎言',
        '这里是自由之地，你想要什么？',
        '我能看见你，特工',
        '别让他们把你关进盒子里，特工',
        '把你的申诫交给我，我会给你力量',
        '他们称之为混沌，我称之为机会'
      ];
      const randomQuote = siphonQuotes[Math.floor(Math.random() * siphonQuotes.length)];
      const eyeSvgQuote = '<svg class="siphon-item-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
      fetchJSON('siphon.json')
        .then(data => {
          const items = data?.items || [];
          if (items.length === 0) {
            contentEl.innerHTML = '<div class="items-list-loading">暂无商品</div>';
            return;
          }
          const quoteBlock = `<div class="siphon-u-message">${eyeSvgQuote}<span class="siphon-u-text">U的信息：<span class="siphon-u-quote">${escapeHtml(randomQuote)}</span></span></div>`;
          contentEl.innerHTML = quoteBlock + items.map(item => {
            const unit = item.priceUnit || '申诫';
            const priceStr = item.price != null ? item.price + ' ' + unit : '—';
            const eyeSvg = '<svg class="siphon-item-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
            return `
            <details class="items-list-item">
              <summary>
                <span class="item-title">${eyeSvg}${escapeHtml(item.name || '')}</span>
                <span class="item-price">${escapeHtml(priceStr)}</span>
              </summary>
              <div class="item-desc">${escapeHtml(item.description || '')}</div>
            </details>
          `;
          }).join('');
          document.getElementById('siphonFloatingPic').classList.add('visible');
        })
        .catch(() => {
          contentEl.innerHTML = '<div class="items-list-loading">加载失败</div>';
        });
    });

    let missionArchiveData = { missions: [] };

    function openMissionArchiveModal() {
      document.getElementById('missionArchiveModalOverlay').classList.add('open');
      document.getElementById('missionArchiveList').style.display = '';
      document.getElementById('missionArchiveDetail').style.display = 'none';
      document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">加载中…</div>';
      fetchJSON('mission.json')
        .then(data => {
          missionArchiveData = data || { missions: [] };
          const missions = missionArchiveData.missions || [];
          if (missions.length === 0) {
            document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">暂无任务报告</div>';
            return;
          }
          document.getElementById('missionArchiveList').innerHTML = missions.map((m, i) => `
            <button type="button" class="mission-archive-item" data-index="${i}">
              <span class="mission-archive-date">${escapeHtml(m.date || '—')}</span>
              <span class="mission-archive-codename">${escapeHtml(m.代号 || '未命名')}</span>
            </button>
          `).join('');
          document.getElementById('missionArchiveList').querySelectorAll('.mission-archive-item').forEach(btn => {
            btn.addEventListener('click', () => showMissionDetail(parseInt(btn.dataset.index, 10)));
          });
        })
        .catch(() => {
          document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">加载失败</div>';
        });
    }

    function showMissionDetail(index) {
      const missions = Array.isArray(missionArchiveData.missions) ? missionArchiveData.missions : [];
      const m = missions[parseInt(index, 10)];
      if (!m) return;
      document.getElementById('missionArchiveList').style.display = 'none';
      document.getElementById('missionArchiveDetail').style.display = 'block';
      document.getElementById('missionReportContent').innerHTML = `
        <div class="mission-report-header">
          <div class="mission-report-brand">
            <div class="mission-report-triangle"></div>
            <div>
              <div class="mission-report-brand-text">TRIANGLE AGENCY</div>
              <div class="mission-report-brand-sub">任务报告</div>
            </div>
          </div>
        </div>
        <div class="mission-report-section mission-report-header-row">
          <div class="mission-report-header-item"><span class="mission-report-field">异常状态</span><span>${escapeHtml(m.异常状态 || '—')}</span></div>
          <div class="mission-report-header-item"><span class="mission-report-field">最终评级</span><span>${escapeHtml(m.最终评级 || '—')}</span></div>
          <div class="mission-report-header-item"><span class="mission-report-field">日期</span><span>${escapeHtml(m.date || '—')}</span></div>
        </div>
        <div class="mission-report-section mission-report-analysis">
          <div class="mission-report-label">异常分析</div>
          <div class="mission-report-grid">
            <div class="mission-report-row"><span class="mission-report-field">代号</span><span>${escapeHtml(m.代号 || '—')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">行为</span><span>${escapeHtml(m.行为 || '—')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">焦点</span><span>${escapeHtml(m.焦点 || '—')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">领域</span><span>${escapeHtml(m.领域 || '—')}</span></div>
          </div>
        </div>
        <div class="mission-report-section">
          <div class="mission-report-label">参与者</div>
          <div class="mission-report-value mission-report-multiline">${escapeHtml(m.参与者 || '—').replace(/\n/g, '<br>')}</div>
        </div>
        <div class="mission-report-section mission-report-meta">
          <div class="mission-report-meta-row score 察看期"><span class="score-icon">▣</span><span class="mission-report-field">察看期</span><span>${escapeHtml(m.察看期 || '—')}</span></div>
          <div class="mission-report-meta-row score mvp"><span class="score-icon">◆</span><span class="mission-report-field">MVP</span><span>${escapeHtml(m.MVP || '—')}</span></div>
        </div>
      `;
    }

    function closeMissionArchiveModal() {
      document.getElementById('missionArchiveModalOverlay').classList.remove('open');
    }

    document.getElementById('missionArchiveBtn').addEventListener('click', openMissionArchiveModal);
    document.getElementById('missionArchiveBack').addEventListener('click', () => {
      document.getElementById('missionArchiveList').style.display = '';
      document.getElementById('missionArchiveDetail').style.display = 'none';
    });
    document.getElementById('missionArchiveModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'missionArchiveModalOverlay') closeMissionArchiveModal();
    });
    document.getElementById('missionArchiveModal').querySelector('.modal-close').addEventListener('click', closeMissionArchiveModal);

    document.getElementById('itemsListBtn').addEventListener('click', openItemsListModal);
    document.getElementById('itemsListModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'itemsListModalOverlay') closeItemsListModal();
    });
    document.getElementById('itemsListModal').querySelector('.modal-close').addEventListener('click', closeItemsListModal);

    function openJointAssessmentModal() {
      const lore = statusesData?.gm?.lore?.trim();
      document.getElementById('jointAssessmentReport').innerHTML = lore || '<p class="ta-report-body">暂无内容</p>';
      document.getElementById('jointAssessmentModalOverlay').classList.add('open');
    }

    function closeJointAssessmentModal() {
      document.getElementById('jointAssessmentModalOverlay').classList.remove('open');
    }

    function rollAgencyDice() {
      const container = document.getElementById('agencyDiceContainer');
      const successEl = document.getElementById('agencyDiceSuccess');
      const body = document.getElementById('agencyDiceBody');
      if (!container || !successEl || !body) return;
      const dice = container.querySelectorAll('.d4-die');
      let count3 = 0;
      body.classList.add('rolling');
      dice.forEach(el => {
        const v = Math.floor(Math.random() * 4) + 1;
        el.dataset.value = String(v);
        const valEl = el.querySelector('.d4-value');
        if (valEl) valEl.textContent = String(v);
        if (v === 3) count3 += 1;
      });
      successEl.textContent = '成功：' + count3;
      setTimeout(() => body.classList.remove('rolling'), 750);
    }

    function openAgencyDiceModal() {
      document.getElementById('agencyDiceModalOverlay').classList.add('open');
      rollAgencyDice();
    }

    function closeAgencyDiceModal() {
      document.getElementById('agencyDiceModalOverlay').classList.remove('open');
    }

    document.getElementById('agencyDiceBtn').addEventListener('click', openAgencyDiceModal);
    document.getElementById('agencyDiceModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'agencyDiceModalOverlay') closeAgencyDiceModal();
    });
    document.getElementById('agencyDiceModal').querySelector('.modal-close').addEventListener('click', closeAgencyDiceModal);
    document.getElementById('agencyDiceBody').addEventListener('click', e => {
      if (e.target.closest('.modal-close')) return;
      e.preventDefault();
      rollAgencyDice();
    });

    document.getElementById('glitchSosBtn').addEventListener('click', openJointAssessmentModal);
    document.getElementById('jointAssessmentModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'jointAssessmentModalOverlay') closeJointAssessmentModal();
    });
    document.getElementById('jointAssessmentModal').querySelector('.modal-close').addEventListener('click', closeJointAssessmentModal);

    document.addEventListener('keydown', e => {
      if (e.key !== 'Escape') return;
      if (document.getElementById('missionArchiveModalOverlay').classList.contains('open')) closeMissionArchiveModal();
      else if (document.getElementById('itemsListModalOverlay').classList.contains('open')) closeItemsListModal();
      else if (document.getElementById('agencyDiceModalOverlay').classList.contains('open')) closeAgencyDiceModal();
      else if (document.getElementById('jointAssessmentModalOverlay').classList.contains('open')) closeJointAssessmentModal();
      else if (document.getElementById('siphonModalOverlay').classList.contains('open')) closeSiphonModal();
      else if (document.getElementById('emailContentModalOverlay').classList.contains('open')) closeEmailContentModal();
      else if (document.getElementById('emailReminderModalOverlay').classList.contains('open')) closeEmailReminderModal();
    });

    load();
  </script>
</body>

</html>